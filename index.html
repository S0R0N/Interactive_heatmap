<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Interactive Heatmaps Plus Network</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
    </head>
    <body>
        <div>
                Simple heatmap plus network 
        </div>
        <script src="https://d3js.org/d3.v5.min.js"></script>
        <script>
//          //##################################################################
            //##                  Variables for the main layout               ##
            //##################################################################            
            var margin        = {top: 30, right: 30, bottom: 30, left: 30};// margenes
            var b_width       = 1600 - margin.left - margin.right;         // ancho
            var b_height      = 20000 - margin.top - margin.bottom;       // altura
            var wrapperWidth  = Math.min(b_width, b_height) * 0.6;   // space for the network and the heatmap
            var Y_link_lenght = 100;                                    // total network size
            var link_margin   = 5;                                    // space between the heatmap and network
            var heatmapWidth  = wrapperWidth - (Y_link_lenght + link_margin);// Ancho del espacio para el heatmap
            var counter       = 0;
            var at            = 600; //milliseconds of animation
            let legend_heigth = 40;

            
//var mousePosition;                                      // la posicion del mouse para el onhover
//          
            /// CREATING THE MAIN SVG or CANVAS
            var svg = d3.select("body").append("svg")
                .attr("width", b_width + margin.left + margin.right )
                .attr("height", b_height + margin.top + margin.bottom );
                /*.on('mousemove', function() {
                    mousePosition = d3.mouse(this);
                    tooltipGroup.attr('transform', 'translate(' + (mousePosition[0] - (150 / 2) + 10) + ',' + (mousePosition[1] + 20) + ')');
                    tooltipText.text(function() {
                        return selectedCell ? '(' + selectedCell.col + ', ' + selectedCell.row + '): value: ' + selectedCell.value : '';
                    });
                });*/    
            // CREATING THE HEATMAP DRAWING SPACE 
            var heatColor = d3.scaleOrdinal()
                            .domain(['YES','PARTIAL','NO'])
                            .range(['#c51b8a','#fa9fb5','#fff']);
                    
            var legends = svg.append('g').attr('class', 'legends')
                //.attr('transform', 'translate('+ ((b_width - wrapperWidth) / 2) + ',' + ((b_height - wrapperWidth) / 2) + ')');// se divide entre dos para colocarlo en la mitad
                .attr('transform', 'translate('+ (Y_link_lenght + link_margin) + ',' + (0) + ')');// se divide entre dos para colocarlo en la mitad
            var GLegends = legends.selectAll(".leg")
                    .data(['YES','PARTIAL','NO']);
            
            GLegends.join(
                    function(enter){
                        let GLegendsEnter = enter.append("g")
                            .attr('class', 'leg');
                        GLegendsEnter.append("rect")
                            .style("stroke", "grey")
                            .style("stroke-width", 1)
                            .attr("height",legend_heigth)
                            .attr("width",legend_heigth)
                            .attr("x", 
                                function(d,i) {
                                        return (((heatmapWidth/3)*i) + ((heatmapWidth/3)/2));
                                    }
                                )
                            .attr("fill",d => heatColor(d));
                        GLegendsEnter.append("text")
                            .attr("x", 
                                function(d,i) {
                                    //return (heatmapWidth/3)*(i);
                                        return (((heatmapWidth/3)*i) + ((heatmapWidth/3)/2) + (legend_heigth+2));
                                    }
                                )
                            .attr("y",legend_heigth/2)
                            .text(d =>d);
                        return(GLegendsEnter);
                    });

            var heatmap = svg.append('g').attr('class', 'heatmap')
                //.attr('transform', 'translate('+ ((b_width - wrapperWidth) / 2) + ',' + ((b_height - wrapperWidth) / 2) + ')');// se divide entre dos para colocarlo en la mitad
                .attr('transform', 'translate('+ (0) + ',' + (legend_heigth) + ')');// se divide entre dos para colocarlo en la mitad
                
            var GyLinks = heatmap.append('g')
                    //var yLink = heatmap.append('g')
                        .attr('class', 'yl')
                        .attr('transform', 'translate(' + 1e-6 + ',' + 1e-6 + ')');
            var GyNodes = heatmap.append('g')
                        .attr('class', 'yn')
                        .attr('transform','translate(' + (Y_link_lenght+ heatmapWidth + link_margin + 10) + ',' + (1e-6) + ')');//fixind the position of the labels for the boxes
                
            var GxNodes = heatmap.append('g')
                        .attr('class', 'xn')
                        .attr('transform', 'translate(' + (Y_link_lenght + link_margin) + ',' + (heatmapWidth + 5) + ')');
            var table = heatmap.append('g').attr('class', 'table')
                    // depronto me toca borrar el Y de linkheight +link_margin, porque no lo tuve en cuenta antes
                    .attr('transform', 'translate(' + (Y_link_lenght + link_margin) + ',' + (0) + ')');
                    //.attr('transform', 'translate(' + (Y_link_lenght + link_margin) + ',' + (Y_link_lenght + link_margin) + ')');
            function collapse(d) {
              if(d.children) {
                d._children = d.children;
                d._children.forEach(collapse);
                d.children = null;
              }
            }
            var ptp = false;
            function get_path_to_parent(d) {
                if(ptp ===false){
                    output = "M" + (d.yLinkScaledLenght) + "," + (d.nodeY-1) +" L"+ (d.yLinkScaledLenght) + "," + d.nodeY;
                    //output = "M" + (Y_link_lenght) + "," + d.nodeY;
                    ptp = true;
                }
                if(d.parent) {
                  //create the path there
                    output = output + " L" + d.parent.yLinkScaledLenght + "," + d.nodeY
                                    + " L" + d.parent.yLinkScaledLenght + "," + d.parent.nodeY; 
                    output = output + get_path_to_parent(d.parent);
                }else{
                    ptp = false;
                }
              
              return(output);
            }
            // Toggle children collapse or expansion on click.
            function click(d) {
                
              if (d.children) {
                  d._children = d.children;
                  d.children = null;
                } else {
                  d.children = d._children;
                  d._children = null;
                }
              updateGraph(d);
            }
            function OnMouseOverExpand(d){
                d3.select(this).style("cursor", "zoom-in"); 
            }
            function OnMouseOverCollapse(d){
                d3.select(this).style("cursor", "zoom-out"); 
            }
            function OnMouseOverNoMore(d){
                d3.select(this).style("cursor", "not-allowed"); 
            }
    //  "mouseout": function(d) {
      //  d3.select(this).style("cursor", "default"); 
      
    
            
        //######################################################################
        //##            FIRST LOAD THE FILE AND INITALIZE STUFF               ##
        //######################################################################
            d3.json("https://raw.githubusercontent.com/S0R0N/draft_viz/master/data/gp_assignments.json").then(
                    function(res){       
                    //Initializing root
                        console.log("raw data");
                        //console.log(res);
                        data_h  = d3.hierarchy(res.property_tree,function(d){return d.children;});
                        samples = res.sample_names;
                        function setYLinkScaledLenght(d, y0, k) {
                            //d.yLinkScaledY = (y0 += d.depth) * k;
                            d.yLinkScaledLenght = (y0= (1+d.depth)) * k; //like an X distribution of the links in the Y axis network
                            if (d.children) d.children.forEach(function(d) { setYLinkScaledLenght(d, y0, k); });
                            return(d);
                        }
                        setYLinkScaledLenght(data_h, data_h.depth, Y_link_lenght / data_h.height);
                        data_h.each(collapse);
                        updateGraph(data_h);
                    }
                );
                
                function updateGraph (source){
                    
                    counter = 0;
                    data_h.eachBefore(function(d){
                        d.id = counter;
                        counter++;
                        return(d.id);
                    });
                    // Sorts the nodes in a tree list like way
                    //data_h.sort(function(a, b) { return b.id - a.id;});
                    data_h.sort(function(a, b) { return a.id - b.id ;});
                    //##################################################################
                    //##            Var for to avoid overlap of the labels            ##
                    //##################################################################
                    //var nodeSpaceY = heatmapWidth/data_h.descendants().length;
                    var nodeSpaceY = 20;
                    var nodeSpaceX = heatmapWidth/samples.length;
                   //console.log(nodeSpaceY);
                    data_h.each(function(d){
                        d.nodeY = ((nodeSpaceY)*(d.id+1)) - (nodeSpaceY/2);
                        return(d);
                    });
                    
                    var nodes = data_h.descendants(),
                        links = data_h.descendants();
                    
                    var yLink = GyLinks.selectAll('g.link') //IT IS STILL NOT WORKING, HAVE TO CONNECT THE DATA TO THE OBJECTTTTTTT
                            .data(links,function(d,i) {
                                return d.data.property_id;
                            });
                    //##################################################################
                    //##                     DRAWING THE NETWORK                      ##
                    //##################################################################
                        yLink.join(
                            function(enter){
                                var yLinkEnter = enter
                                        .append("g")
                                        .attr('class',function(d) {
                                            return 'link '+ d.data.property_id;}
                                        );
                                yLinkEnter
                                        .append("path")
                                        .attr('class',function(d) {return 'link '+ d.data.property_id;})
                                        .style('fill', 'none')
                                        .style('stroke', '#000')
                                        .style('stroke-width', 1)
                                        .attr("d",function(d){
                                                return get_path_to_parent(d);
                                            });
                                    yLinkEnter.append("circle")
                                        .attr('class',function(d) {return 'link '+ d.data.property_id;})
                                        .attr('r', 2)
                                        .attr("transform", function(d) {
                                          return "translate(" + d.yLinkScaledLenght + "," + d.nodeY + ")";
                                        });
                                    return(yLinkEnter);
                            },
                            function(update){
                                var yLinkUpdate = update;
                                    yLinkUpdate.select("path.link")
                                        .attr("d",function(d){
                                            return get_path_to_parent(d);
                                        });
                                        
                                    yLinkUpdate.select("circle")
                                        .attr("transform", function(d){
                                              return "translate(" + d.yLinkScaledLenght + "," + d.nodeY + ")";
                                            }
                                        );
                                return(yLinkUpdate);
                            },function(exit){
                                var yLinkExit = exit.remove();
                                    yLinkExit.select("g.link");
                                    yLinkExit.select("circle.link")
                                            .attr("r",1e-6);
                                    yLinkExit.select("path.link")
                                            .style('stroke-width', 0);                                    
                                return(yLinkExit);
                            }
                        );
                   // Ynode has the same proble that ylink had, the g element is not being created and the sub elements are flying. Gotta ground them. 
                    //##################################################################
                    //##                     DRAWING THE NETWORK                      ##
                    //##################################################################
                        
                    var yNode = GyNodes.selectAll('g.y-node')
                            .data(nodes,function(d) {
                                return d.data.property_id;
                            });
                        yNode.join(
                            function(enter){
                                let yNodeEnter = enter
                                        .append("g")
                                        .attr('class',function(d) {
                                            return 'y-node '+ d.data.property_id;}
                                        );
                                    yNodeEnter.append("text")
                                        .attr('class',function(d) {
                                            return 'y-node '+ d.data.property_id;}
                                        )
                                        //.attr('transform', function(d) { return 'translate(' + 0 + ',' + (d.nodeY +(nodeSpaceY/2)) + ')'; })
                                        //.attr('transform', function(d) { return 'translate(' + 0 + ',' + (d.nodeY+3) + ')'; })
                                        .attr('transform', function(d) { 
                                            console.log("d.yLinkScaledLenght");
                                            console.log(d.yLinkScaledLenght);
                                            return 'translate(' + d.yLinkScaledLenght + ',' + (d.nodeY+3) + ')'; 
                                        })
                                        .attr("font-family", "sans-serif")
                                        .attr("font-size", 12)
                                        .text(function(d) { return d.data.name;})
                                        //.attr('cursor', 'pointer')
                                        .style("fill", function(d) {
                                            return (d.children ? "black": "black");
                                        })
                                        .style("font-weight", function(d) {
                                            return (d.children ? "normal": "bold");
                                        })
                                        .style("font-style", function(d) {
                                            return (d.children ? "italic": "normal");
                                        })
                                        //cursor type
                                        .on('mouseover', function (d){//Changing the cursor appearance 
                                            if(d.children){
                                                d3.select(this).style("cursor", "zoom-out");
                                            }else{
                                                d3.select(this).style("cursor", "zoom-in");
                                            }
                                            if(d.height === 0){
                                                d3.select(this)
                                                    .style("cursor", "not-allowed");
                                                }
                                            }
                                        )
                                        .on('click', click);
                                return(yNodeEnter);
                            },
                            function(update){
                                let yNodeUpdate = update;
                                    yNodeUpdate.select("text")
                                        .style("fill", function(d) {
                                            return (d.children ? "black": "black");
                                        })
                                        .style("font-weight", function(d) {
                                            return (d.children ? "normal": "bold");
                                        })
                                        .style("font-style", function(d) {
                                            return (d.children ? "italic": "normal");
                                        })
                                        .on('mouseover', function (d){//Changing the cursor appearance 
                                            if(d.children){
                                                d3.select(this).style("cursor", "zoom-out");
                                            }else{
                                                d3.select(this).style("cursor", "zoom-in");
                                            }
                                            if(d.height === 0){
                                                d3.select(this)
                                                    .style("cursor", "not-allowed");
                                                }
                                            }
                                        )
                                        //cursor type
                                        //
                                        //.attr('transform', function(d) { return 'translate(' + 0 + ',' + (d.nodeY +(nodeSpaceY/2)) + ')'; });
                                        //.attr('transform', function(d) { return 'translate(' + 0 + ',' + (d.nodeY+3) + ')'; });
                                        .attr('transform', function(d) { return 'translate(' + d.yLinkScaledLenght + ',' + (d.nodeY+3) + ')'; });
                                return(yNodeUpdate);
                            },function(exit){
                                let yNodeExit = exit.remove();
                                    yNodeExit.select("text.link")
                                            .attr("font-size", 0);
                            }
                        );
                    console.log(nodeSpaceY*nodes.length);
                    heatmap.select("g.xn")
                            .attr('transform', 'translate(' + (Y_link_lenght + link_margin) + ',' + (nodeSpaceY*nodes.length + 5) + ')');
                
                    var xNode = GxNodes.selectAll('g.x-node')
                        .data(samples);
                        xNode.join(
                            function(enter){
                                let xNodeEnter = enter
                                        .append("g")
                                        .attr('class',"x-node");
                                    xNodeEnter.append("text")
                                        .attr('class',"x-node")
                                        .style("text-anchor", 'start')
                                        .attr("transform", function(d,i) { return "translate(" + ((nodeSpaceX*i) + (nodeSpaceX/2))+ "," + 0 + ")"; })
                                        .attr("font-family", "sans-serif")
                                        .attr("font-size", 12)
                                        .attr("writing-mode", "vertical-rl")
                                        .text(function(d) { return d; });
                                return(xNodeEnter);
                            },
                            function(update){
                                let xNodeUpdate = update;
                                    xNodeUpdate.select("text.x-node")
                                        .attr("transform", function(d,i) { return "translate(" + ((nodeSpaceX*i) + (nodeSpaceX/2))+ "," + 0 + ")"; });
                                return(xNodeUpdate);
                            },function(exit){
                                let xNodeExit = exit.remove();
                                    xNodeExit.select("text.x-node")
                                            .attr("font-size", 0);
                            }
                        );
                    //##################################################################
                    //##                 END DRAWING THE NETWORK                      ##
                    //##################################################################

                    //##################################################################
                    //##                     DRAWING THE BOXES                        ##
                    //##################################################################
                    // Number of columns are the numeber of samples
                    
                    var nCols = samples.length;
                    var bandX = d3.scaleBand()
                            .domain(d3.range(nCols))
                            .range([0, heatmapWidth]);
                        //.range([0, 600]);
                    // Number of rows are the number of nodes, including the root. 
                    //var nRows     = data_h.descendants().length;
                    //let badYwidth = 20;
                    /*var bandY = d3.scaleBand()
                            .domain(d3.range(nRows))
                            //.range([0, heatmapWidth]); //allowing the squares to expand to infinite
                            .range([0, b_height]);*/

                    var rows = table.selectAll('.row')
                           .data(nodes,function(d) {
                               return d.data.property_id;
                           });
                    rows.join(
                        function(enter){
                            let rowEnter = enter.append('g')
                                //.attr('class', 'row')
                                .attr('class',function(d) {return 'row '+ d.data.property_id;})
                                .attr('transform', function(d, i) {

                                    return 'translate(0, ' + (d.nodeY- (nodeSpaceY/2)) + ')';
                                });  
                            let rowEnterRect = rowEnter
                                    .selectAll('rect')
                                    .data(function(d) {
                                        return(d.data.result);
                                    });
                            rowEnterRect
                                    .join(
                                        function(enter){
                                            let rowEnterRect = enter.append('rect')
                                                .style('fill', function (d) {return heatColor(d);})
                                                .style('opacity', 0.7)
                                                .attr('x', function(d, i) {return bandX(i);})
                                                .style('stroke', '#000')
                                                .style('stroke-width', 1)
                                                .attr('width', bandX.bandwidth())
                                                .attr('height', nodeSpaceY);
                                                //.attr('height', bandX.bandwidth());
                                            return(rowEnterRect);
                                        }
                                    );
                        },
                        function(update){
                            //no le tengo mucha fe por la division del joing update del objeto children
                            //probably I have to create a group to modify these dudes 
                            //console.log("updating row");
                            let rowUpdate = update;
                                rowUpdate
                                    .attr('transform', function(d, i) {
                                        return 'translate(0, ' + (d.nodeY- (nodeSpaceY/2)) + ')';
                                    });
                                rowUpdate.selectAll('rect')
                                    .style('fill', function (d) {
                                            //console.log("rect data on update");
                                            return heatColor(d);
                                        })
                                    .style('opacity', 0.7)
                                    .attr('x', function(d, i) {return bandX(i);})
                                    .style('stroke', '#000')
                                    .style('stroke-width', 1)
                                    .attr('width', bandX.bandwidth())
                                    .attr('height', nodeSpaceY);
                                    //.attr('height', bandX.bandwidth());
                                    //.attr('height', bandY.bandwidth());
                        },
                        function(exit){
                            let rowExit = exit.remove();
                                rowExit.selectAll("rect")
                                    .style('stroke', '#fff')
                                    .style('stroke-width', 1e-6)
                                    .attr('width', 1e-6)
                                    .attr('height', 1e-6);
                            return(rowExit);
                        }
                    );
                };
         
            
        </script>
    </body>
</html>