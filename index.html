<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Interactive Heatmap</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" crossorigin="anonymous">
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    </head>
    
    <body>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
        <script>
//          //##################################################################
            //##                  Variables for the main layout               ##
            //##################################################################            
            let margin             = {top: 30, right: 30, bottom: 30, left: 30};// margenes
            let b_width            = 1200 - margin.left - margin.right;         // ancho
            let b_height           = 1000 - margin.top - margin.bottom;       // altura
            let top_banner_width   = b_width;
            let top_banner_heigth  = 200;
            let sample_name_heigth = 60;
            let navbar_h           = 56;
            let wrapperWidth       = Math.min(b_width, b_height) * 0.6;   // space for the network and the heatmap
            
            let svg1_h             = top_banner_heigth + margin.top + margin.bottom;
            let svg1_w             = top_banner_width + margin.left + margin.right;
            let legend_h           = 24;//depends on the size of the FONT, ie., for font 12 - 16px
            
            let Y_link_lenght      = 100;                                    // total network size
            let link_margin        = 5;                                    // space between the heatmap and network
            let heatmapWidth       = wrapperWidth - (Y_link_lenght + link_margin);// Ancho del espacio para el heatmap
            let counter            = 0;
            let at                 = 600; //milliseconds of animation
            
            
            //var mousePosition;                                      
            //la posicion del mouse para el onhover

            /// CREATING THE MAIN SVG or CANVAS

            let ht = d3.select("html")
                    /*.style("margin", 0+"px")
                    .style("font-family", '-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol"')
                    .style("font-size", 1+"rem")
                    .style("font-weight",400)
                    .style("line-heigth", 1.5)
                    .style("color", "#212529")
                    .style("text-align","left")
                    .style("background-color", "#fff")*/
            ;
            let bo = d3.select("body")
            ;
    //##########################################################################
    //##                       DRAWING THE TOOLTIPS                           ##
    //##########################################################################    
    
            let tt1 = d3.select("body")
                    .append("span")
                    .attr("class","tt1")
                    .style("visibility","hidden")
                    .style("width","120px")
                    .style("background-color","black")
                    .style("color","#fff")
                    .style("text-align","center")
                    .style("padding","5px")
                    .style("border-radius","6px")
                    .style("position","fixed")
                    .style("z-index","101")
                    .text("You will have to wait around 5-8 seconds")
            ;
    //##########################################################################
    //##                     DRAWING THE NAVIGATION BAR                       ##
    //##########################################################################
            let navb = d3.select("body")
                    .append("nav")
                    .attr("class","navbar navbar-expand-lg navbar-light bg-light")
                    .style('position','fixed')
                    .style('top',0)
                    .style("width","100%")
                    .style("z-index",100)
            ;
            //INTERACTIVE TITLE OF THE WEBSITE
            navb.append("a")
                    .attr("href","#")
                    .attr("class","navbar-brand")
                    .text("Interactive Heatmap")
            ;
            //BUTTON TO HIDE THE RESET AND SEARCH BAR WHEN THE SCREEN IS SMALL
            navb.append("button")
                    .attr("class","navbar-toggler")
                    .attr("type","button")
                    .attr("data-toggle","collapse")
                    .attr("data-target","#navbarSC")
                    .attr("aria-controls","navbarSC")
                    .attr("aria-expanded","false")
                    .attr("aria-label","Toggle Navigation")
                    .append("span")
                        .attr("class","navbar-toggler-icon")
            ;
            
            let navbd  = navb.append("div")
                    .attr("class","collapse navbar-collapse")
                    .attr("id","navbarSC")
                    .attr("position","relative")
                    .style("z-index",50)
            ;
            //reset all button
            let navbd_ul = navbd
                    .append("ul")
                            .attr("class","navbar-nav mr-auto mt-2 mt-lg-0");
            navbd_ul    
                    .append("li")
                        .attr("class","nav-item")
                        .append("button")
                            .attr("class", "btn btn-outline-success reset rb")
                            .attr("type", "button")
                            .text("Reset")
            ;
            //expand all button
             navbd_ul
                    .append("li")
                        .attr("class","nav-item")
                        .append("button")
                            .attr("class", "btn btn-outline-success reset eab")
                            .attr("type", "button")
                            .text("Expand All<!>")
                            .on("mouseover",function(){
                                tt1
                                    .style("visibility","visible")
                                    .style("top",(this.getBoundingClientRect().top + this.getBoundingClientRect().height+ 3)+"px")
                                    .style("left",(this.getBoundingClientRect().left + this.getBoundingClientRect().width/2)+"px")
                                ;
                                }
                            )
                            .on("mouseout",function(){
                                tt1
                                    .style("visibility","hidden");
                            })
            ;

            //let navbdfs = navbdf navbd
            let navbdfs = navbd
                    .append("select")//navigationbar division select
                        .attr("class","ndfs")//nav-div-form-select
                        .attr("name","properties")
                        .attr("title","Property Search")
                        .attr("tabindex",-1)
                        .attr("aria-hidden","true")
            ;
            navbdfs.append("option")/* to be able to set the placeholder*/;
           
            let opt_names = navbdfs.append("optgroup")
                    .attr("label","Property Names")
                    .attr("class","ndfso_names")//nav-div-form-optiongroup-Names
            ;
            /*let opt_ids   = navbdfs.append("optgroup")
                    .attr("label","Property Ids")
                    .attr("class","ndfso_ids")//nav-div-form-optiongroup-IDs
            ;*/


    //##########################################################################
    //##                     DRAWING THE TOP BANNER                           ##
    //##########################################################################
            //let svg1 = d3.select("body")
            //let svg1 = navb
            let svg1 = bo
                .append("div")
                .attr("class","svg1")
                //.style('position','relative')
                .style('position','fixed')
                .style('top',(navbar_h)+"px")
                .style("width","100%")
                .style("z-index",2)
                .style("background-color","rgba(255, 255, 255, 0.70")
                //.attr("transform", "translate("+ (0) + "," + (10) + ")")// se divide entre dos para colocarlo en la mitad
                    .append("svg")
                        //.style('position','fixed')
                        .style('position','relative')
                        .style("z-index",2)
                        //.style("background-color","rgba(255, 255, 255, 0.70")
                        .attr("width", svg1_w)
                        .attr("height", svg1_h)
            ;
            

                
            let heatColor = d3.scaleOrdinal()
                            .domain(['YES','PARTIAL','NO'])
                            //.range(['#c51b8a','#fa9fb5','#fff'])
                            .range(['#6c6c6c','#cecece','white']);
            ;
                    
            let top_banner_inside = svg1.append('g')
                    .attr('class', 'top_banner_in')
                    .attr('transform', 'translate('+ (0) + ',' + (0) + ')')// se divide entre dos para colocarlo en la mitad
            ;
            
            //let legends = top_banner_inside.append('g')
            let legends = svg1.append('g')
            //let legends = svg1.append('div')
                    .attr('class', 'legends')
                //.attr('transform', 'translate('+ ((b_width - wrapperWidth) / 2) + ',' + ((b_height - wrapperWidth) / 2) + ')');// se divide entre dos para colocarlo en la mitad
                    //.attr('transform', 'translate('+ (margin.left) + ',' + (margin.top+ 60) + ')')// se divide entre dos para colocarlo en la mitad
                    .attr('transform', 'translate('+ (margin.left) + ',' + (margin.top+ 60) + ')')// se divide entre dos para colocarlo en la mitad
                //Trying to make them freeze
            ;
            let GLegends = legends.selectAll(".leg")
                    .data(['YES','PARTIAL','NO'])
            ;
            
            GLegends.join(
                    function(enter){
                        //let GLegendsEnter = enter.append("g")
                        let GLegendsEnter = enter.append("g")
                            .attr('class', 'leg')
                            .attr('transform', 'translate(' + (0) + ',' + (sample_name_heigth) + ')')
                            .style("vertical-align", "middle")
                        ;
                        GLegendsEnter.append("rect")
                            .attr("height",legend_h)
                            .attr("width",legend_h)
                            .style("stroke", "grey")
                            .style("stroke-width", 1)
                            //x="50%" y="50%" dominant-baseline="middle" text-anchor="middle"
                            .attr("x",0)
                            .attr("y",function(d,i) {
                                    //return ((i*legend_h)+((i*legend_h)*(3/4)) );
                                    return ((i*legend_h));
                                }
                            )
                            .attr("fill",d => heatColor(d))
                            
                        ;
                        GLegendsEnter.append("text")
                            //.attr('transform', 'translate(' + (legend_h+5) + ',' + (0) + ')')
                            .attr("x", legend_h+5)
                            //.style("text-anchor","start")
                            .style("font-size","12px")
                            .attr("y",function(d,i) {
                                    return ((i*legend_h)+((legend_h)*(3/4)) );
                                }
                            )
                            //.style("x",legend_h*2)
                            .text(d =>d)
                        ;
                        return(GLegendsEnter);
                    })
            ;
            let GxNodes = top_banner_inside.append('g')
                        .attr('class', 'xn')
                        //.attr('transform', 'translate(' + (Y_link_lenght + link_margin) + ',' + (heatmapWidth + 5) + ')');
                        //.attr('transform', 'translate(' + (Y_link_lenght + link_margin) + ',' + (top_banner_heigth - sample_name_heigth) + ')')
                        .attr('transform', 'translate(' + (Y_link_lenght + link_margin) + ',' + (top_banner_heigth) + ')')
            ;
            
    //Think an adaptative size of SVG canvas to draw the heatmap. 
    //##########################################################################
    //##                   DRAWING THE TOP HEATMAP                            ##
    //##########################################################################
            let dv = d3.select("body")  
                .append("div")
                .attr("class","svg")
                //.style("overflow","scroll")
                .style("position","absolute")
                .style("top",(navbar_h + 60 + top_banner_heigth + +  margin.top + margin.top + margin.bottom)+"px")
                .style("z-index",0)
            ;
            let svg = dv
                    .append("svg")
                    .attr("width", b_width + margin.left + margin.right )
                    .attr("height", b_height + margin.top + margin.bottom )
                    //.attr('transform', 'translate('+ (0) + ',' + (top_banner_heigth + margin.top + margin.bottom) + ')')
                    .attr('transform', 'translate('+ (0) + ',' + (margin.top) + ')')
            ;
                /*.on('mousemove', function() {
                    mousePosition = d3.mouse(this);
                    tooltipGroup.attr('transform', 'translate(' + (mousePosition[0] - (150 / 2) + 10) + ',' + (mousePosition[1] + 20) + ')');
                    tooltipText.text(function() {
                        return selectedCell ? '(' + selectedCell.col + ', ' + selectedCell.row + '): value: ' + selectedCell.value : '';
                    });
                });*/    
            // CREATING THE HEATMAP DRAWING SPACE 
            

            let heatmap = svg.append('g').attr('class', 'heatmap')
                //.attr('transform', 'translate('+ ((b_width - wrapperWidth) / 2) + ',' + ((b_height - wrapperWidth) / 2) + ')');// se divide entre dos para colocarlo en la mitad
                //.attr('transform', 'translate('+ (0) + ',' + (legend_heigth) + ')');// se divide entre dos para colocarlo en la mitad
                .attr('transform', 'translate('+ (0) + ',' + (0) + ')');// se divide entre dos para colocarlo en la mitad
                
            let GyLinks = heatmap.append('g')
                    //var yLink = heatmap.append('g')
                        .attr('class', 'yl')
                        .attr('transform', 'translate(' + 1e-6 + ',' + 1e-6 + ')');
            let GyNodes = heatmap.append('g')
                        .attr('class', 'yn')
                        .attr('transform','translate(' + (Y_link_lenght+ heatmapWidth + link_margin + 10) + ',' + (1e-6) + ')');//fixind the position of the labels for the boxes
                
            
            let table = heatmap.append('g').attr('class', 'table')
                    // depronto me toca borrar el Y de linkheight +link_margin, porque no lo tuve en cuenta antes
                    .attr('transform', 'translate(' + (Y_link_lenght + link_margin) + ',' + (0) + ')');
                    //.attr('transform', 'translate(' + (Y_link_lenght + link_margin) + ',' + (Y_link_lenght + link_margin) + ')');
            //##################################################################
            //##                   HELPER FUNCTIONS                           ##
            //##################################################################
            function collapse(d) {
              if(d.children) {
                d._children = d.children;
                d._children.forEach(collapse);
                d.children = null;
              }
            }
            function expand(d) {
              if(d._children) {
                d.children = d._children;
                d._children.forEach(expand);
                d._children = null;
              }
            }
            let ptp = false;
            function get_path_to_parent(d) {
                if(ptp ===false){
                    output = "M" + (d.yLinkScaledLenght) + "," + (d.nodeY-1) +" L"+ (d.yLinkScaledLenght) + "," + d.nodeY;
                    //output = "M" + (Y_link_lenght) + "," + d.nodeY;
                    ptp = true;
                }
                if(d.parent) {
                  //create the path there
                    output = output + " L" + d.parent.yLinkScaledLenght + "," + d.nodeY
                                    + " L" + d.parent.yLinkScaledLenght + "," + d.parent.nodeY; 
                    output = output + get_path_to_parent(d.parent);
                }else{
                    ptp = false;
                }
              
              return(output);
            }
            // Toggle children collapse or expansion on click.
            function click(d) {
                
              if (d.children) {
                  d._children = d.children;
                  d.children = null;
                } else {
                  d.children = d._children;
                  d._children = null;
                }
              updateGraph(d);
            }
            function OnMouseOverExpand(d){
                d3.select(this).style("cursor", "zoom-in"); 
            }
            function OnMouseOverCollapse(d){
                d3.select(this).style("cursor", "zoom-out"); 
            }
            function OnMouseOverNoMore(d){
                d3.select(this).style("cursor", "not-allowed"); 
            }
            function expandAllParents(d){
                //console.log("d parents to expand");
                if(d._children){
                    //expand
                    d.children = d._children;
                    d._children = null;
                }else{
                    //console.log("something wrong happened this is the d");
                }
                if(d.parent){
                    /*console.log("d.expandAllParents()");
                    console.log(d.parent);*/
                    expandAllParents(d.parent);
                }else{
                    //console.log("no more parents, termine");
                }
            }
            let o;
            let tofind;
            function getFilteredData(d) {
                //if(d.data.name.toLowerCase().replace(/\s+/g, '').replace(/[^\w\s]/gi, '') === tofind.toLowerCase().replace(/\s+/g, '').replace(/[^\w\s]/gi, '')){
                if(d.idx === tofind){
                    //console.log("match");
                    o = d;
                    expandAllParents(o);
                }else{
                   // console.log("did not find it search children");
                    if(d._children){
                        d._children.forEach(getFilteredData);

                    }else{
                        //console.log("este nodo no tiene unexpanded children");
                    }
                    
                }
                return o;
            }
        //######################################################################
        //##            FIRST LOAD THE FILE AND INITALIZE STUFF               ##
        //######################################################################
            d3.json("https://raw.githubusercontent.com/S0R0N/draft_viz/master/data/gp_assignments.json").then(
                    function(res){       
                    //Initializing root
                        //console.log("raw data");
                        //console.log(res);
                        data_h  = d3.hierarchy(res.property_tree,function(d){return d.children;});
                        samples = res.sample_names;
                        counter = 0;
                        function initCustomVars(d, y0, k) {
                            //d.yLinkScaledY = (y0 += d.depth) * k;
                            counter++;
                            let h = d.data.property_id?d.data.property_id:d.data.step_id;// the name, lowecase and with no spaces. 
                            d.yLinkScaledLenght = (y0= (1+d.depth)) * k; //like an X distribution of the links in the Y axis network
                            d.idx = d.data.name.toLowerCase().replace(/\s+/g, '').replace(/[^\w\s]/gi, '')+h+counter ;
                            if (d.children) d.children.forEach(function(d) { initCustomVars(d, y0, k); });
                            return(d);
                        }
                        counter = 0;
                        initCustomVars(data_h, data_h.depth, Y_link_lenght / data_h.height);
                        //console.log("data_h");
                        //console.log(data_h);
                        opt_names.selectAll(".ndfso_names_options")
                            //.data(data_h.descendants().slice(0, 100))
                            .data(data_h.descendants())
                            .enter()
                            .append("option")
                                .attr("class","ndfso_names_options")
                                .attr("value",function(d){
                                        //return "name-"+d.idx;
                                        return d.idx;
                                    }
                                )
                                .text(function(d){
                                        return d.data.name;
                                    }
                                )
                        ;
                        $(document).ready(function() {
                            $('.ndfs').select2({
                                placeholder: 'Select an option',
                                width: '818px',
                                //data: s2dt,
                                minimumInputLength: 3
                            })
                            .on("select2:select", function(evt){
                                    //Conecting the select to the hierarchical dataset
                                    //tofind = evt.params.data.text;
                                    tofind = evt.params.data.id;
                                    //console.log("evt.params.data");
                                    //console.log(evt.params.data);
                                    // searching the selected function on the hierchical dataset
                                    // if the selected item is not expanded it will find it expand its parents and return it
                                    //let testf = getFilteredData(data_h.descendants(),tofind);
                                    data_h.descendants().forEach(getFilteredData);
                                    /*console.log("o");                            
                                    console.log(o);*/
                                    
                                    //after finding the selected item, refresh the heatmap
                                    updateGraph(data_h);
                                    // animate the scroll to the item and the color of the selected item. 
                                    //console.log("o.idx");
                                    //console.log(o.idx);
                                    let tar = d3.selectAll("."+o.idx)
                                        .select(".y-node")
                                        .style("fill", "blue")
                                    ;
                                    //console.log("testf.data.name");
                                    //console.log(o.idx);
                                    //console.log("tar");
                                    //console.log(tar);
                                    
                                    d3.transition()
                                        .duration(750)
                                        .tween("scroll", scrollTween(o.nodeY))
                                        .transition()
                                            .duration(1500)
                                            .tween("selected_text", borderTween("black"))
                                    ;
                                    function borderTween(target) {
                                        return function() {

                                        let ip = d3.interpolateRgb(tar.style("fill"),target);
                                        return function(t) { 
                                            //scrollTo(0, ip(t)); 
                                            tar.style("fill",ip(t));
                                            //change the object's color';
                                        };
                                      };
                                    } 
                                    function scrollTween(offset) {
                                      return function() {
                                        let ip = d3.interpolateNumber(window.pageYOffset || document.scrollingElement.scrollTop, offset);
                                        return function(t) { scrollTo(0, ip(t)); };
                                      };
                                    }    

                                }
                            );
                        });
                        //Initializing the reset button
                        navb.select(".rb")
                            .on("click",function(evt){
                                    //console.log(this);
                                    data_h.descendants().slice(1).forEach(collapse);
                                    updateGraph(data_h);
                                }
                            )
                        ;
                        navb.select(".eab")
                            .on("click",function(){
                                  //data_h.each(collapse);
                                  //EXPAND ALL
                                  //this.style("cursor","progress");
                                  //this.style.cursor = "progress";
                                  //$("body").css("cursor", "progress");
                                  //this.style.cursor = "progress";
                                  data_h.each(expand);
                                  updateGraph(data_h);
                                  //$("body").css("cursor", "default");
                                  //this.style.cursor = "default";
                                  //this.style("cursor","default");
                                }
                            )
                        ;
                        console.log("data_h");
                        //console.log(data_h.descendants().slice(1).forEach(collapse));
                        //data_h.each(collapse);
                        data_h.descendants().slice(1).forEach(collapse);
                        updateGraph(data_h);
                    }
                );
        //######################################################################
        //##                       UDAPTE FUNCTION                            ##
        //######################################################################
                function updateGraph (source){
                    //bo.style("cursor","progress");
                    //console.log("changed the cursor");
                    counter = 0;
                    data_h.eachBefore(function(d){
                        d.id = counter;
                        counter++;
                        return(d.id);
                    });
                    // Sorts the nodes in a tree list like way
                    //data_h.sort(function(a, b) { return b.id - a.id;});
                    data_h.sort(function(a, b) { return a.id - b.id ;});
                    //##################################################################
                    //##            Var for to avoid overlap of the labels            ##
                    //##################################################################
                    //var nodeSpaceY = heatmapWidth/data_h.descendants().length;
                    var nodeSpaceY = 20;
                    var nodeSpaceX = heatmapWidth/samples.length;
                   //console.log(nodeSpaceY);
                    data_h.each(function(d){
                        d.nodeY = ((nodeSpaceY)*(d.id+1)) - (nodeSpaceY/2);
                        return(d);
                    });
                    
                    var nodes = data_h.descendants(),
                        links = data_h.descendants();
                    //console.log("nodeSpaceY*nodes.length");
                    //console.log(nodeSpaceY*nodes.length);
                    
                    /*let ssvg = svg.select("svg")
                    .attr("width", b_width + margin.left + margin.right )
                    .attr("height", nodeSpaceY*nodes.length + margin.top + margin.bottom )*/
                    svg
                        .attr("width", b_width + margin.left + margin.right )
                        .attr("height", nodeSpaceY*nodes.length + margin.top + margin.bottom )
                    //.attr('transform', 'translate('+ (0) + ',' + (top_banner_heigth + margin.top + margin.bottom) + ')')
                    //.attr('transform', 'translate('+ (0) + ',' + (0) + ')')
                    ;
                    //console.log("svg");
                    //console.log(svg);
                    
                    
                    var yLink = GyLinks.selectAll('g.link') //IT IS STILL NOT WORKING, HAVE TO CONNECT THE DATA TO THE OBJECTTTTTTT
                            .data(links,function(d,i) {
                                return d.idx;
                            });
                    //##################################################################
                    //##                     DRAWING THE NETWORK                      ##
                    //##################################################################
                        yLink.join(
                            function(enter){
                                var yLinkEnter = enter
                                        .append("g")
                                        .attr('class',function(d) {
                                            return 'link '+ d.idx;}
                                        );
                                yLinkEnter
                                        .append("path")
                                        .attr('class',function(d) {return 'link '+ d.idx;})
                                        .style('fill', 'none')
                                        .style('stroke', '#000')
                                        .style('stroke-width', 1)
                                        .attr("d",function(d){
                                                return get_path_to_parent(d);
                                            });
                                    yLinkEnter.append("circle")
                                        .attr('class',function(d) {return 'link '+ d.idx;})
                                        .attr('r', 2)
                                        .attr("transform", function(d) {
                                          return "translate(" + d.yLinkScaledLenght + "," + d.nodeY + ")";
                                        });
                                    return(yLinkEnter);
                            },
                            function(update){
                                var yLinkUpdate = update;
                                    yLinkUpdate.select("path.link")
                                        .attr("d",function(d){
                                            return get_path_to_parent(d);
                                        });
                                        
                                    yLinkUpdate.select("circle")
                                        .attr("transform", function(d){
                                              return "translate(" + d.yLinkScaledLenght + "," + d.nodeY + ")";
                                            }
                                        );
                                return(yLinkUpdate);
                            },function(exit){
                                var yLinkExit = exit.remove();
                                    yLinkExit.select("g.link");
                                    yLinkExit.select("circle.link")
                                            .attr("r",1e-6);
                                    yLinkExit.select("path.link")
                                            .style('stroke-width', 0);                                    
                                return(yLinkExit);
                            }
                        );
                   // Ynode has the same proble that ylink had, the g element is not being created and the sub elements are flying. Gotta ground them. 
                    //##################################################################
                    //##                     DRAWING THE NETWORK                      ##
                    //##################################################################
                        
                    var yNode = GyNodes.selectAll('g.y-node')
                            .data(nodes,function(d) {
                                return d.idx;
                            });
                        yNode.join(
                            function(enter){
                                let yNodeEnter = enter
                                        .append("g")
                                        .attr('class',function(d) {
                                            return 'y-node '+ d.idx;}
                                        );
                                    yNodeEnter.append("text")
                                        .attr('class',function(d) {
                                            return 'y-node '+ d.idx;}
                                        )
                                        //.attr('transform', function(d) { return 'translate(' + 0 + ',' + (d.nodeY +(nodeSpaceY/2)) + ')'; })
                                        //.attr('transform', function(d) { return 'translate(' + 0 + ',' + (d.nodeY+3) + ')'; })
                                        .attr('transform', function(d) { 
                                            //console.log("d.yLinkScaledLenght");
                                            //console.log(d.yLinkScaledLenght);
                                            return 'translate(' + d.yLinkScaledLenght + ',' + (d.nodeY+3) + ')'; 
                                        })
                                        .attr("font-family", "sans-serif")
                                        .attr("font-size", 12)
                                        .text(function(d) {
                                            let t = "normal";
                                            if(d.height ===0){
                                                //es extremo font-weight is normal
                                                t = d.data.name;
                                            }else{
                                                t = d._children?d.data.name+"  +":d.data.name+"  -";
                                            }    
                                                return t;
                                            }
                                        )
                                        //.attr('cursor', 'pointer')
                                        .style("fill","black")
                                        .style("font-weight", function(d) {
                                            let fw = "normal";
                                            if(d.height ===0){
                                                //es extremo font-weight is normal
                                                fw = "normal";
                                            }else{
                                                fw = d.children ? "normal": "bold";
                                            }
                                            return (fw);
                                        })
                                        .style("font-style", function(d) {
                                            return (d.children ? "italic": "normal");
                                        })
                                        //cursor type
                                        .on('mouseover', function (d){//Changing the cursor appearance 
                                            if(d.children){
                                                d3.select(this).style("cursor", "zoom-out");
                                            }else{
                                                d3.select(this).style("cursor", "zoom-in");
                                            }
                                            if(d.height === 0){
                                                d3.select(this)
                                                    .style("cursor", "not-allowed");
                                                }
                                            }
                                        )
                                        .on('click', click);
                                return(yNodeEnter);
                            },
                            function(update){
                                let yNodeUpdate = update;
                                    yNodeUpdate.select("text")
                                        .style("fill","black")
                                        .style("font-weight", function(d) {
                                            let fw = "normal";
                                            if(d.height ===0){
                                                //es extremo font-weight is normal
                                                fw = "normal";
                                            }else{
                                                fw = d.children ? "normal": "bold";
                                            }
                                            return (fw);
                                        })
                                        .style("font-style", function(d) {
                                            
                                            return (d.children ? "italic": "normal");
                                        })
                                        .text(function(d) {
                                            let t = "normal";
                                            if(d.height ===0){
                                                //es extremo font-weight is normal
                                                t = d.data.name;
                                            }else{
                                                t = d._children?d.data.name+"  +":d.data.name+"  -";
                                            }    
                                                return t;
                                            }
                                        )
                                        .on('mouseover', function (d){//Changing the cursor appearance 
                                            if(d.children){
                                                d3.select(this).style("cursor", "zoom-out");
                                            }else{
                                                d3.select(this).style("cursor", "zoom-in");
                                            }
                                            if(d.height === 0){
                                                d3.select(this)
                                                    .style("cursor", "not-allowed");
                                                }
                                            }
                                        )
                                        //cursor type
                                        //
                                        //.attr('transform', function(d) { return 'translate(' + 0 + ',' + (d.nodeY +(nodeSpaceY/2)) + ')'; });
                                        //.attr('transform', function(d) { return 'translate(' + 0 + ',' + (d.nodeY+3) + ')'; });
                                        .attr('transform', function(d) { return 'translate(' + d.yLinkScaledLenght + ',' + (d.nodeY+3) + ')'; });
                                return(yNodeUpdate);
                            },function(exit){
                                let yNodeExit = exit.remove();
                                    yNodeExit.select("text.link")
                                            .attr("font-size", 0);
                            }
                        );
                
                    var xNode = GxNodes.selectAll('g.x-node')
                        .data(samples);
                        xNode.join(
                            function(enter){
                                let xNodeEnter = enter
                                        .append("g")
                                        .attr('class',"x-node");
                                    xNodeEnter.append("text")
                                        .attr('class',"x-node")
                                        .style("text-anchor", 'start')
                                        .attr("font-family", "sans-serif")
                                        .attr("font-size", 12)
                                        .attr("transform", function(d,i) { return "translate(" + ((nodeSpaceX*i) + (nodeSpaceX/2))+ "," + sample_name_heigth + ")"+" rotate(270)"; })
                                        
                                        //.style("text-orientation","sideways")
                                        //.attr("writing-mode","sideways-rl")
                                        .text(function(d) { return d; })
                                    ;
                                return(xNodeEnter);
                            },
                            function(update){
                                let xNodeUpdate = update;
                                    xNodeUpdate.select("text.x-node")
                                        //.attr("transform", function(d,i) { return "translate(" + ((nodeSpaceX*i) + (nodeSpaceX/2))+ "," + 0 + ")"; });
                                        .attr("transform", function(d,i) { return "translate(" + ((nodeSpaceX*i) + (nodeSpaceX/2))+ "," + sample_name_heigth + ")"+" rotate(270)"; });
                                return(xNodeUpdate);
                            },function(exit){
                                let xNodeExit = exit.remove();
                                    xNodeExit.select("text.x-node")
                                            .attr("font-size", 0);
                            }
                        );
                    //##################################################################
                    //##                 END DRAWING THE NETWORK                      ##
                    //##################################################################

                    //##################################################################
                    //##                     DRAWING THE BOXES                        ##
                    //##################################################################
                    // Number of columns are the numeber of samples
                    
                    var nCols = samples.length;
                    var bandX = d3.scaleBand()
                            .domain(d3.range(nCols))
                            .range([0, heatmapWidth]);

                    var rows = table.selectAll('.row')
                           .data(nodes,function(d) {
                               return d.idx;
                           });
                    rows.join(
                        function(enter){
                            let rowEnter = enter.append('g')
                                //.attr('class', 'row')
                                .attr('class',function(d) {return 'row '+ d.idx;})
                                .attr('transform', function(d, i) {

                                    return 'translate(0, ' + (d.nodeY- (nodeSpaceY/2)) + ')';
                                });  
                            let rowEnterRect = rowEnter
                                    .selectAll('rect')
                                    .data(function(d) {
                                        return(d.data.result);
                                    });
                            rowEnterRect
                                    .join(
                                        function(enter){
                                            let rowEnterRect = enter.append('rect')
                                                .style('fill', function (d) {return heatColor(d);})
                                                .style('opacity', 0.7)
                                                .attr('x', function(d, i) {return bandX(i);})
                                                .style('stroke', '#000')
                                                .style('stroke-width', 1)
                                                .attr('width', bandX.bandwidth())
                                                .attr('height', nodeSpaceY);
                                                //.attr('height', bandX.bandwidth());
                                            return(rowEnterRect);
                                        }
                                    );
                        },
                        function(update){
                            //no le tengo mucha fe por la division del joing update del objeto children
                            //probably I have to create a group to modify these dudes 
                            //console.log("updating row");
                            let rowUpdate = update;
                                rowUpdate
                                    .attr('transform', function(d, i) {
                                        return 'translate(0, ' + (d.nodeY- (nodeSpaceY/2)) + ')';
                                    });
                                rowUpdate.selectAll('rect')
                                    .style('fill', function (d) {
                                            //console.log("rect data on update");
                                            return heatColor(d);
                                        })
                                    .style('opacity', 0.7)
                                    .attr('x', function(d, i) {return bandX(i);})
                                    .style('stroke', '#000')
                                    .style('stroke-width', 1)
                                    .attr('width', bandX.bandwidth())
                                    .attr('height', nodeSpaceY);
                                    //.attr('height', bandX.bandwidth());
                                    //.attr('height', bandY.bandwidth());
                        },
                        function(exit){
                            let rowExit = exit.remove();
                                rowExit.selectAll("rect")
                                    .style('stroke', '#fff')
                                    .style('stroke-width', 1e-6)
                                    .attr('width', 1e-6)
                                    .attr('height', 1e-6);
                            return(rowExit);
                        }
                    );
                //console.log("reseted the cursor");
                //bo.style("cursor","default");
                    
                };            
        </script>
    </body>
</html>
