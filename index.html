<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Interactive Heatmap</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="shortcut icon" type="image/png" href="https://imagizer.imageshack.com/img923/5444/WSvDT8.png"/>
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" crossorigin="anonymous">
        <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/css/select2.min.css" rel="stylesheet" />
    </head>
    
    <body>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://d3js.org/d3.v5.min.js" charset="utf-8"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/js/bootstrap.min.js" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.1/dist/js/select2.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.19/lodash.js"></script>
        <script>
//          //##################################################################
            //##                  Variables for the main layout               ##
            //##################################################################            
            //let margin             = {top: 30, right: 30, bottom: 30, left: 30};// margenes
            const margin             = {   top: window.innerHeight * 0.3,   left: 30,   bottom: window.innerHeight * 0.4,   right: 30 }; 
            const b_width            = window.innerWidth - margin.left - margin.right;
            const b_height           = window.innerHeight - margin.top - margin.bottom;
            let top_banner_width     = b_width;
            const top_banner_heigth  = 200;
            const sample_name_heigth = 200;
            const navbar_h           = 56;
            let wrapperWidth         = Math.min(b_width, b_height) * 1.5;   // like a rectangle with its longer side being half longer than its smaller side
            
            let svg1_h               = top_banner_heigth + margin.top + margin.bottom;
            let svg1_w               = top_banner_width + margin.left + margin.right;
            const legend_h           = 20;//depends on the size of the FONT, ie., for font 12 - 16px
            
            const Y_link_lenght      = 80;                                    // total network size
            const link_margin        = 5;                                    // space between the heatmap and network
            let heatmapWidth         = wrapperWidth - (Y_link_lenght + link_margin);// the maximum widht of the heatmap
            let heatmapHeight;     //the maximum size of the heatmap
            let counter              = 0;
            const at                 = 600; //milliseconds of animation
            const pw                 = ["GenProp0001",	"GenProp0023",	"GenProp0030",	"GenProp0036",	"GenProp0037",	"GenProp0038",	"GenProp0047",	"GenProp0048",	"GenProp0057",	"GenProp0058",	"GenProp0109",	"GenProp0110",	"GenProp0111",	"GenProp0117",	"GenProp0118",	"GenProp0120",	"GenProp0124",	"GenProp0136",	"GenProp0139",	"GenProp0141",	"GenProp0143",	"GenProp0146",	"GenProp0147",	"GenProp0150",	"GenProp0155",	"GenProp0159",	"GenProp0160",	"GenProp0162",	"GenProp0163",	"GenProp0164",	"GenProp0171",	"GenProp0187",	"GenProp0188",	"GenProp0189",	"GenProp0193",	"GenProp0203",	"GenProp0217",	"GenProp0218",	"GenProp0220",	"GenProp0221",	"GenProp0222",	"GenProp0223",	"GenProp0231",	"GenProp0233",	"GenProp0238",	"GenProp0240",	"GenProp0250",	"GenProp0253",	"GenProp0254",	"GenProp0259",	"GenProp0264",	"GenProp0265",	"GenProp0266",	"GenProp0268",	"GenProp0269",	"GenProp0272",	"GenProp0273",	"GenProp0275",	"GenProp0281",	"GenProp0283",	"GenProp0304",	"GenProp0309",	"GenProp0466",	"GenProp0468",	"GenProp0473",	"GenProp0478",	"GenProp0480",	"GenProp0481",	"GenProp0562",	"GenProp0624",	"GenProp0639",	"GenProp0641",	"GenProp0642",	"GenProp0653",	"GenProp0659",	"GenProp0671",	"GenProp0673",	"GenProp0677",	"GenProp0681",	"GenProp0687",	"GenProp0688",	"GenProp0689",	"GenProp0691",	"GenProp0692",	"GenProp0697",	"GenProp0704",	"GenProp0706",	"GenProp0708",	"GenProp0709",	"GenProp0711",	"GenProp0713",	"GenProp0718",	"GenProp0724",	"GenProp0728",	"GenProp0730",	"GenProp0732",	"GenProp0736",	"GenProp0738",	"GenProp0744",	"GenProp0747",	"GenProp0750",	"GenProp0753",	"GenProp0754",	"GenProp0759",	"GenProp0766",	"GenProp0786",	"GenProp0787",	"GenProp0792",	"GenProp0797",	"GenProp0813",	"GenProp0822",	"GenProp0829",	"GenProp0837",	"GenProp0862",	"GenProp0878",	"GenProp0893",	"GenProp0908",	"GenProp0909",	"GenProp0927",	"GenProp0942",	"GenProp0950",	"GenProp0991",	"GenProp1017",	"GenProp1058",	"GenProp1064",	"GenProp1070",	"GenProp1084",	"GenProp1098",	"GenProp1215",	"GenProp1216",	"GenProp1217",	"GenProp1218",	"GenProp1219",	"GenProp1220",	"GenProp1221",	"GenProp1222",	"GenProp1223",	"GenProp1224",	"GenProp1225",	"GenProp1226",	"GenProp1227",	"GenProp1228",	"GenProp1229",	"GenProp1230",	"GenProp1231",	"GenProp1233",	"GenProp1234",	"GenProp1235",	"GenProp1236",	"GenProp1237",	"GenProp1238",	"GenProp1239",	"GenProp1240",	"GenProp1241",	"GenProp1242",	"GenProp1243",	"GenProp1244",	"GenProp1245",	"GenProp1246",	"GenProp1247",	"GenProp1248",	"GenProp1249",	"GenProp1250",	"GenProp1251",	"GenProp1252",	"GenProp1253",	"GenProp1254",	"GenProp1255",	"GenProp1256",	"GenProp1257",	"GenProp1258",	"GenProp1259",	"GenProp1260",	"GenProp1261",	"GenProp1262",	"GenProp1263",	"GenProp1264",	"GenProp1265",	"GenProp1266",	"GenProp1267",	"GenProp1268",	"GenProp1269",	"GenProp1270",	"GenProp1271",	"GenProp1272",	"GenProp1273",	"GenProp1274",	"GenProp1275",	"GenProp1276",	"GenProp1277",	"GenProp1278",	"GenProp1279",	"GenProp1280",	"GenProp1281",	"GenProp1282",	"GenProp1283",	"GenProp1284",	"GenProp1286",	"GenProp1287",	"GenProp1288",	"GenProp1289",	"GenProp1290",	"GenProp1291",	"GenProp1292",	"GenProp1293",	"GenProp1294",	"GenProp1295",	"GenProp1296",	"GenProp1297",	"GenProp1298",	"GenProp1299",	"GenProp1300",	"GenProp1301",	"GenProp1302",	"GenProp1303",	"GenProp1304",	"GenProp1305",	"GenProp1306",	"GenProp1307",	"GenProp1308",	"GenProp1309",	"GenProp1310",	"GenProp1311",	"GenProp1312",	"GenProp1313",	"GenProp1315",	"GenProp1316",	"GenProp1317",	"GenProp1318",	"GenProp1320",	"GenProp1321",	"GenProp1322",	"GenProp1323",	"GenProp1324",	"GenProp1325",	"GenProp1326",	"GenProp1327",	"GenProp1328",	"GenProp1329",	"GenProp1330",	"GenProp1331",	"GenProp1332",	"GenProp1333",	"GenProp1334",	"GenProp1335",	"GenProp1336",	"GenProp1337",	"GenProp1338",	"GenProp1339",	"GenProp1340",	"GenProp1341",	"GenProp1342",	"GenProp1343",	"GenProp1344",	"GenProp1345",	"GenProp1346",	"GenProp1347",	"GenProp1348",	"GenProp1349",	"GenProp1351",	"GenProp1352",	"GenProp1353",	"GenProp1354",	"GenProp1355",	"GenProp1356",	"GenProp1357",	"GenProp1358",	"GenProp1359",	"GenProp1360",	"GenProp1361",	"GenProp1362",	"GenProp1363",	"GenProp1364",	"GenProp1365",	"GenProp1366",	"GenProp1367",	"GenProp1368",	"GenProp1369",	"GenProp1370",	"GenProp1371",	"GenProp1372",	"GenProp1373",	"GenProp1374",	"GenProp1375",	"GenProp1376",	"GenProp1377",	"GenProp1378",	"GenProp1379",	"GenProp1380",	"GenProp1381",	"GenProp1382",	"GenProp1383",	"GenProp1384",	"GenProp1385",	"GenProp1386",	"GenProp1387",	"GenProp1388",	"GenProp1389",	"GenProp1390",	"GenProp1391",	"GenProp1392",	"GenProp1393",	"GenProp1394",	"GenProp1395",	"GenProp1396",	"GenProp1397",	"GenProp1398",	"GenProp1399",	"GenProp1400",	"GenProp1401",	"GenProp1402",	"GenProp1403",	"GenProp1404",	"GenProp1405",	"GenProp1406",	"GenProp1407",	"GenProp1408",	"GenProp1409",	"GenProp1410",	"GenProp1411",	"GenProp1412",	"GenProp1413",	"GenProp1414",	"GenProp1415",	"GenProp1416",	"GenProp1417",	"GenProp1418",	"GenProp1419",	"GenProp1420",	"GenProp1421",	"GenProp1423",	"GenProp1424",	"GenProp1425",	"GenProp1426",	"GenProp1427",	"GenProp1428",	"GenProp1429",	"GenProp1430",	"GenProp1431",	"GenProp1432",	"GenProp1433",	"GenProp1434",	"GenProp1436",	"GenProp1437",	"GenProp1438",	"GenProp1439",	"GenProp1441",	"GenProp1442",	"GenProp1443",	"GenProp1444",	"GenProp1445",	"GenProp1446",	"GenProp1447",	"GenProp1448",	"GenProp1449",	"GenProp1450",	"GenProp1451",	"GenProp1452",	"GenProp1453",	"GenProp1454",	"GenProp1455",	"GenProp1457",	"GenProp1458",	"GenProp1459",	"GenProp1460",	"GenProp1461",	"GenProp1462",	"GenProp1463",	"GenProp1464",	"GenProp1465",	"GenProp1466",	"GenProp1467",	"GenProp1468",	"GenProp1469",	"GenProp1470",	"GenProp1471",	"GenProp1472",	"GenProp1473",	"GenProp1474",	"GenProp1475",	"GenProp1476",	"GenProp1477",	"GenProp1478",	"GenProp1479",	"GenProp1480",	"GenProp1481",	"GenProp1482",	"GenProp1483",	"GenProp1484",	"GenProp1485",	"GenProp1486",	"GenProp1487",	"GenProp1488",	"GenProp1489",	"GenProp1490",	"GenProp1491",	"GenProp1492",	"GenProp1493",	"GenProp1494",	"GenProp1495",	"GenProp1496",	"GenProp1497",	"GenProp1498",	"GenProp1499",	"GenProp1501",	"GenProp1502",	"GenProp1503",	"GenProp1504",	"GenProp1505",	"GenProp1506",	"GenProp1507",	"GenProp1508",	"GenProp1509",	"GenProp1510",	"GenProp1511",	"GenProp1512",	"GenProp1513",	"GenProp1514",	"GenProp1515",	"GenProp1516",	"GenProp1517",	"GenProp1518",	"GenProp1520",	"GenProp1521",	"GenProp1522",	"GenProp1523",	"GenProp1524",	"GenProp1525",	"GenProp1526",	"GenProp1527",	"GenProp1528",	"GenProp1529",	"GenProp1530",	"GenProp1533",	"GenProp1534",	"GenProp1535",	"GenProp1536",	"GenProp1537",	"GenProp1538",	"GenProp1539",	"GenProp1540",	"GenProp1541",	"GenProp1542",	"GenProp1543",	"GenProp1544",	"GenProp1545",	"GenProp1546",	"GenProp1547",	"GenProp1548",	"GenProp1549",	"GenProp1550",	"GenProp1551",	"GenProp1552",	"GenProp1553",	"GenProp1554",	"GenProp1555",	"GenProp1556",	"GenProp1557",	"GenProp1558",	"GenProp1559",	"GenProp1560",	"GenProp1561",	"GenProp1562",	"GenProp1563",	"GenProp1564",	"GenProp1565",	"GenProp1566",	"GenProp1567",	"GenProp1568",	"GenProp1569",	"GenProp1570",	"GenProp1571",	"GenProp1572",	"GenProp1573",	"GenProp1574",	"GenProp1575",	"GenProp1576",	"GenProp1577",	"GenProp1578",	"GenProp1579",	"GenProp1580",	"GenProp1581",	"GenProp1582",	"GenProp1583",	"GenProp1584",	"GenProp1585",	"GenProp1586",	"GenProp1587",	"GenProp1588",	"GenProp1589",	"GenProp1590",	"GenProp1591",	"GenProp1592",	"GenProp1593",	"GenProp1594",	"GenProp1595",	"GenProp1596",	"GenProp1597",	"GenProp1598",	"GenProp1599",	"GenProp1600",	"GenProp1601",	"GenProp1602",	"GenProp1603",	"GenProp1604",	"GenProp1605",	"GenProp1606",	"GenProp1607",	"GenProp1608",	"GenProp1609",	"GenProp1610",	"GenProp1611",	"GenProp1612",	"GenProp1613",	"GenProp1614",	"GenProp1615",	"GenProp1616",	"GenProp1617",	"GenProp1619",	"GenProp1620",	"GenProp1621",	"GenProp1622",	"GenProp1623",	"GenProp1624",	"GenProp1625",	"GenProp1626",	"GenProp1627",	"GenProp1628",	"GenProp1629",	"GenProp1630",	"GenProp1631",	"GenProp1632",	"GenProp1633",	"GenProp1634",	"GenProp1635",	"GenProp1636",	"GenProp1637",	"GenProp1638",	"GenProp1639",	"GenProp1640",	"GenProp1641",	"GenProp1643",	"GenProp1644",	"GenProp1645",	"GenProp1646",	"GenProp1647",	"GenProp1648",	"GenProp1649",	"GenProp1650",	"GenProp1651",	"GenProp1652",	"GenProp1653",	"GenProp1654",	"GenProp1655",	"GenProp1656",	"GenProp1657",	"GenProp1658",	"GenProp1660",	"GenProp1661",	"GenProp1662",	"GenProp1663",	"GenProp1664",	"GenProp1665",	"GenProp1666",	"GenProp1667",	"GenProp1668",	"GenProp1669",	"GenProp1670",	"GenProp1671",	"GenProp1672",	"GenProp1673",	"GenProp1674",	"GenProp1675",	"GenProp1676",	"GenProp1677",	"GenProp1678",	"GenProp1679",	"GenProp1680",	"GenProp1681",	"GenProp1682",	"GenProp1683",	"GenProp1684",	"GenProp1685",	"GenProp1686",	"GenProp1687",	"GenProp1688",	"GenProp1689",	"GenProp1690",	"GenProp1691",	"GenProp1692",	"GenProp1693",	"GenProp1694",	"GenProp1695",	"GenProp1696",	"GenProp1697",	"GenProp1698",	"GenProp1699",	"GenProp1701",	"GenProp1702",	"GenProp1703",	"GenProp1704",	"GenProp1705",	"GenProp1706",	"GenProp1707",	"GenProp1708",	"GenProp1709",	"GenProp1710",	"GenProp1711",	"GenProp1712",	"GenProp1713",	"GenProp1715",	"GenProp1716",	"GenProp1717",	"GenProp1718",	"GenProp1719",	"GenProp1720",	"GenProp1721",	"GenProp1722",	"GenProp1723",	"GenProp1724",	"GenProp1725",	"GenProp1726",	"GenProp1727",	"GenProp1728",	"GenProp1729",	"GenProp1730",	"GenProp1731",	"GenProp1732",	"GenProp1733",	"GenProp1734",	"GenProp1735",	"GenProp1736",	"GenProp1737",	"GenProp1739",	"GenProp1740",	"GenProp1741",	"GenProp1742",	"GenProp1743",	"GenProp1744",	"GenProp1745",	"GenProp1746",	"GenProp1747",	"GenProp1748",	"GenProp1749",	"GenProp1750",	"GenProp1751",	"GenProp1752",	"GenProp1753",	"GenProp1754",	"GenProp1755",	"GenProp1756",	"GenProp1757",	"GenProp1758",	"GenProp1759",	"GenProp1760",	"GenProp1761",	"GenProp1762",	"GenProp1763",	"GenProp1764",	"GenProp2007",	"GenProp2088",	"GenProp2089",	"GenProp2090",	"GenProp2097"];
            const mtpw               = ["GenProp0029",	"GenProp0033",	"GenProp0046",	"GenProp0125",	"GenProp0144",	"GenProp0183",	"GenProp0199",	"GenProp0204",	"GenProp0219",	"GenProp0241",	"GenProp0255",	"GenProp0261",	"GenProp0287",	"GenProp0305",	"GenProp0479",	"GenProp0489",	"GenProp0611",	"GenProp0612",	"GenProp0615",	"GenProp0616",	"GenProp0643",	"GenProp0644",	"GenProp0645",	"GenProp0686",	"GenProp0698",	"GenProp0700",	"GenProp0710",	"GenProp0720",	"GenProp0725",	"GenProp0729",	"GenProp0758",	"GenProp0788",	"GenProp0789",	"GenProp0791",	"GenProp0793",	"GenProp0796",	"GenProp0812",	"GenProp0814",	"GenProp0836",	"GenProp0841",	"GenProp0930",	"GenProp0969",	"GenProp0970",	"GenProp0971",	"GenProp0972",	"GenProp0975",	"GenProp1032",	"GenProp1034",	"GenProp2010",	"GenProp2013",	"GenProp2033",	"GenProp2035",	"GenProp2050",	"GenProp2052",	"GenProp2086",	"GenProp2087",	"GenProp2095",	"GenProp2096",	"GenProp2098",	"GenProp2099"];
            let nodes;     //pointer to the selected nodes
            let m                    = "path";         //mode of filter
            let data_h;    //buffer for all data
            let p_data; //buffer for pathdata
            let mp_data;//buffer for metapathdata
            let selected_data;//pointer to the selected tree dataset
            const nodeSpaceY         = 20;
            const minZoom              = 0.2;
            const maxZoom              = 1.05;
            let fcheck               = [true,true,true];//vector to manage the filter checkbox selection for YES, NO, PARTIAL
            let rawJson;              //buffer for the Json
            let zScale = d3.scaleLinear()
                .domain([0,100])
                .range([minZoom,maxZoom])
            ;
            //var mousePosition;                                      
            //la posicion del mouse para el onhover

            /// CREATING THE MAIN SVG or CANVAS

            let ht = d3.select("html")
            ;
            let bo = d3.select("body")
            ;
    //##########################################################################
    //##                       DRAWING THE TOOLTIPS                           ##
    //##########################################################################    
    
            let tt1 = d3.select("body")
                .append("span")
                .attr("class","tt1")
                .style("visibility","hidden")
                .style("width","120px")
                .style("background-color","black")
                .style("color","#fff")
                .style("text-align","center")
                .style("padding","5px")
                .style("border-radius","6px")
                .style("position","fixed")
                .style("z-index","101")
                .text("When the heatmap is completely expanded, the site's response becomes slow")
            ;
    //##########################################################################
    //##                     DRAWING THE NAVIGATION BAR                       ##
    //##########################################################################
            let navb = d3.select("body")
                .append("nav")
                .attr("class","navbar navbar-expand-lg navbar-light bg-light")
                .style('position','fixed')
                .style('top',0)
                .style("width","100%")
                .style("z-index",100)
            ;
            //INTERACTIVE TITLE OF THE WEBSITE
            navb.append("img")
                .attr("src",'https://imagizer.imageshack.com/img924/2927/rgQ28R.png')
                .attr("class","d-inline-block align-top")
            ;
            navb.append("a")
                .attr("href","#")
                .attr("class","navbar-brand")
                .style("margin-left","1rem")
                .text("Interactive Heatmap")
            ;
            //BUTTON TO HIDE THE RESET AND SEARCH BAR WHEN THE SCREEN IS SMALL
            navb.append("button")
                .attr("class","navbar-toggler")
                .attr("type","button")
                .attr("data-toggle","collapse")
                .attr("data-target","#navbarSC")
                .attr("aria-controls","navbarSC")
                .attr("aria-expanded","false")
                .attr("aria-label","Toggle Navigation")
                .append("span")
                    .attr("class","navbar-toggler-icon")
            ;
            
            let navbd  = navb.append("div")
                .attr("class","collapse navbar-collapse")
                .attr("id","navbarSC")
                .attr("position","relative")
                .style("z-index",50)
            ;
            // HEre goes the elemetns of the collapsive navbar
            let navbdi = navbd.append("ul")
                .attr("class","nav navbar-nav")
            ;
            navbdi
                .append("li")
                .attr("class","nav-item")
                    .append("a")
                    .attr("class","nav-link")
                    .attr("href","https://s0r0n.github.io/Interactive_heatmap/index2.html")
                    .text("Version2")
            ;
            navbdi
                .append("li")
                .attr("class","nav-item active")
                    .append("a")
                    .attr("class","nav-link")
                    .attr("href","https://s0r0n.github.io/Interactive_heatmap/index.html")
                    .text("Version1")
            ;
            /*let opt_ids   = navbdfs.append("optgroup")
                    .attr("label","Property Ids")
                    .attr("class","ndfso_ids")//nav-div-form-optiongroup-IDs
            ;*/
    //##########################################################################
    //##                           DRAWING FOOTER                             ##
    //##########################################################################
             let foot = d3.select("body")
                .append("footer")
                .attr("class","footer bg-light")
                .style('position','fixed')
                .style('bottom',0)
                .style("width","100%")
                .style("height","20px")
                .style("z-index",100)
                    .append("div")
                    .attr("class","fc")
                    .style("width","auto")
                    .style("text-align","center")
                        .append("p")
                        .attr("class","pfc")
                        .style("color","#777")
                        .style("margin","0")
                        .text("Lab Name here")
            ;
    //##########################################################################
    //##                 DRAWING GENERAL CONTENT CONTAINER(gcc)               ##
    //##########################################################################
            let gcc = bo
                .append("div")
                .attr("class","gcc")
                .style("display","flex")
                .style("width","100%")
                .style("position","fixed")
                .style("top","0")
                .style("bottom","0")
                .style("margin-bottom","20px")
                //.style('top',(navbar_h)+"px")
                .style("margin-top",(navbar_h)+"px")
            ;
    //##########################################################################
    //##                     DRAWING  SIDE BAR (sdb)                          ##
    //##########################################################################    
            let sdb = gcc
                .append("div")
                .attr("class","sdb")
                .style("width","300px")
                .style("min-width","300px")
                .style("height","auto")
                .style("padding","15px")
                .style("padding-bottom","0")
                .style("border-right-width","thin")
                .style("border-right-style","solid")
                .style("border-right-color","rgb(221,221,221)")
                .style("overflow-y","scroll")
                .style("overflow-x","hidden")
            ;
            
            //SELECT TO FILTER THE DATA
            let sdbf = sdb.append("form")
            ;
                    
            let filter_menu = sdbf.append("div")
                .attr("class","form-group")
            ;
            filter_menu.append("label")
                .attr("for","fs1")//filter menu select filter select
                .text("Filter Content")
            ;
            let filter_menu_selec = filter_menu.append("select")
                .attr("id","fs1")
                .attr("class","fms form-control")//filter menu select
                .attr("name","filter")
                .on("change",function(){
                    if(nodes.length>0){
                        //console.log("this");
                        //console.log(this.value);
                        m = this.value;
                        //initHeatmapData(m);
                        //htere is something in the dataset so filer
                        //you filter the nodes and run the update, with the new nodes. 
                    }else{
                        //there is nothing, do nothing. 
                    };
                })
            ;
            //console.log(filter_menu_selec);
            filter_menu_selec.append("option")
                .attr("class","fmdph")//place holder
                .attr("value","all")
                .text("All")
            ;
            filter_menu_selec.append("option")
                .attr("class","fmdo")//options
                .attr("value","path")
                .attr("selected","true")
                .text("Pathways")
            ;
            filter_menu_selec.append("option")
                .attr("class","fmdo")//options
                .attr("value","mpath")
                .text("Meta-Pathways")
            ;
            /*filter_menu_selec.append("option")
                .attr("class","fmdo")//options
                .attr("value","mpath")
                .text("Meta-Pathways")
            ;*/
            //sdb.append("hr");
            let fr = sdbf.append("div")
                .attr("class","form-group text-center")
            ;
            let fr_Yes = fr.append("div")
                .attr("class","form-check form-check-inline")
            ;
            fr_Yes.append("input")
                .attr("type","checkbox")
                .attr("class","fry form-check-input")
                .attr("value","Y")
                .attr("id","fr_y")
                .property("checked",fcheck[0])
            ;
            fr_Yes.append("label")
                .attr("class","form-check-label")
                .attr("for","fr_y")
                .text("YES")
            ;
            let fr_Par = fr.append("div")
                .attr("class","form-check form-check-inline")
            ;
            fr_Par.append("input")
                .attr("type","checkbox")
                .attr("class","frp form-check-input")
                .attr("value","P")
                .attr("id","fr_p")
                .property("checked",fcheck[1])
            ;
            fr_Par.append("label")
                .attr("class","form-check-label")
                .attr("for","fr_p")
                .text("PARTIAL")
            ;
            let fr_No = fr.append("div")
                    .attr("class","form-check form-check-inline")
            ;
            fr_No.append("input")
                .attr("type","checkbox")
                .attr("class","frn form-check-input")
                .attr("value","N")
                .attr("id","fr_n")
                .property("checked",fcheck[2])
            ;
            fr_No.append("label")
                .attr("class","form-check-label")
                .attr("for","fr_n")
                .text("NO")
            ;
            let sdbb = sdb.append("div")//side bar buttion
                .attr("class","form-group text-center")
            ;
            sdbb.append("button")
                .attr("id","update")
                .attr("type","submit")
                .attr("class","btn btn btn-outline-primary btn-sm ub")   
                .text("Update")
            ;
            sdbb.append("button")
                .attr("type","reset")
                .attr("class","btn btn-outline-secondary btn-sm rb")
                .text("Reset")
            ;
            /*sdbb.append("button")
                .attr("class", "btn btn-outline-success btn-sm rpb")
                .attr("type", "button")
                .text("R")
            ;*/
            sdbb.append("button")
                .attr("class", "btn btn-outline-secondary btn-sm eab")
                .attr("type", "button")
                .text("Expand all")
                .on("mouseover",function(){
                    tt1
                        .style("visibility","visible")
                        .style("top",(this.getBoundingClientRect().top + this.getBoundingClientRect().height+ 3)+"px")
                        .style("left",(this.getBoundingClientRect().left + this.getBoundingClientRect().width/2)+"px")
                    ;
                    }
                )
                .on("mouseout",function(){
                    tt1
                        .style("visibility","hidden");
                })
            ;
            sdb.append("hr");

            let sbdfs = sdb
                .append("select")//navigationbar division select
                    .attr("class","ndfs select2-hidden-accessible")//nav-div-form-select
                    .attr("name","properties")
                    .attr("title","Property Search")
                    .attr("tabindex",-1)
                    .style("width","100%")
                    .attr("aria-hidden","true")
            ;
            sbdfs.append("option")/* to be able to set the placeholder*/;
           
            let opt_names = sbdfs.append("optgroup")
                .attr("label","Property Names")
                .attr("class","ndfso_names")
            ;
            sdb.append("hr");
    //##########################################################################
    //##                       Space for the legends                          ##
    //##########################################################################
            let heatColor = d3.scaleOrdinal()
                .domain(['YES','PARTIAL','NO'])
                .range(['#6c6c6c','#cecece','white']);
            ;
            let legend_menu = sdb
                .append("ul")
                .attr("class","nav nav-tabs")
                    .append("li")
                        .attr("class","nav-item mr-auto");
            let legends = legend_menu.append('svg')
                    .attr("width",100)
                    .attr("height",100)
                    .style("vertical-align", "middle")
                    .append("g")
                        .attr('class', 'legends')
                        .attr('transform', 'translate('+ (margin.left) + ',' + (0) + ')')// se divide entre dos para colocarlo en la mitad
            ;
            let GLegends = legends.selectAll(".leg")
                    .data(['YES','PARTIAL','NO'])
            ;
            GLegends.join(
                function(enter){
                    let GLegendsEnter = enter.append("g")
                        .attr('class', 'leg')
                        .attr('transform', 'translate(' + (0) + ',' + (0) + ')')
                        .style("vertical-align", "middle")
                    ;
                    GLegendsEnter.append("rect")
                        .attr("height",legend_h)
                        .attr("width",legend_h)
                        .style("stroke", "grey")
                        .style("stroke-width", 1)
                        .attr("x",0)
                        .attr("y",function(d,i) {
                                return ((i*legend_h)+10);
                            }
                        )
                        .attr("fill",d => heatColor(d))
                    ;
                    GLegendsEnter.append("text")    
                        .attr("x", legend_h+5)
                        .style("font-size","12px")
                        .attr("y",function(d,i) {
                                return ((i*legend_h)+((legend_h)*(3/4))+10 );
                            }
                        )
                        .text(d =>d)
                    ;
                    return(GLegendsEnter);
                })
            ;
           sdb.append("hr");
    //##########################################################################
    //##                           ZOOM CONTROLS                              ##
    //##########################################################################
    //<div class="slidecontainer">
    //  <input type="range" min="1" max="100" value="50" class="slider" id="myRange">
    //</div>
            let sdzc = sdb.append("div")//side bar buttion
                .attr("class","form-group")
            ;
            sdzc.append("label")
                .attr("for","zc")//filter menu select filter select
                .text("Zoom control")
            ;
            sdzc.append("input")
                    .attr("class","form-control zcc")
                    .attr("id","zc")
                    .attr("type","range")
                    .attr("min",0)
                    .attr("max",100)
                    .attr("value",50)
                    
            ;
            sdb.append("hr");
    //##########################################################################
    //##                 DRAWING  MAIN CONTENT (mct)                          ##
    //##########################################################################
            let mct = gcc
                .append("div")
                .attr("class","mct")
                .style("width","100%")
                //.style("height","auto")
                .style("position","relative")
                .style("box-shadow","0 0 5px 3px rgba(0,0,0,0.25) inset")
                .style("overflow-y","scroll")
                    
            ;
    //##########################################################################
    //##                   DRAWING THE LEGEND CONTAINER                       ##
    //##########################################################################
            
    //Think an adaptative size of SVG canvas to draw the heatmap. 
    //##########################################################################
    //##                   DRAWING THE TOP HEATMAP                            ##
    //##########################################################################
            //let dv = d3.select("body")  
            let dv = mct
                .append("div")
                .attr("class","svg")
                .style("z-index",0)
            ;
    //##########################################################################
    //##                     HEATMAP CONTENT I ZOOM THIS                      ##
    //##########################################################################
            // this object is the window to see the target of the zoom.
            let svg = dv
                    .append("svg")
                    .attr('transform', 'translate('+ (0) + ',' + (0) + ')')
            ;
            let gZoom = svg.append("g")
                .attr("class","chart")
                .attr('transform', 'translate('+margin.left+', '+margin.top+ ')')
           ;
            // CREATING THE HEATMAP DRAWING SPACE 
            let top_banner_inside = gZoom.append('g')
                    .attr('class', 'top_banner_in')
                    .attr('transform', 'translate('+ (0) + ',' + (0) + ')')// se divide entre dos para colocarlo en la mitad
            ;
            
            let heatmap = gZoom.append('g').attr('class', 'heatmap')
                .attr('transform', 'translate('+ (0) + ',' + (sample_name_heigth+20) + ')');// se divide entre dos para colocarlo en la mitad

            let GxNodes = top_banner_inside.append('g')
                .attr('class', 'xn')
                .attr('transform', 'translate(' + (Y_link_lenght + link_margin) + ',' + (0) + ')')
            ;
    
            let GyLinks = heatmap.append('g')
                    //var yLink = heatmap.append('g')
                        .attr('class', 'yl')
                        .attr('transform', 'translate(' + 1e-6 + ',' + 1e-6 + ')');
            let GyNodes = heatmap.append('g')
                        .attr('class', 'yn')
                        .attr('transform','translate(' + (Y_link_lenght+ heatmapWidth + link_margin + 10) + ',' + (1e-6) + ')');//fixind the position of the labels for the boxes
            
            let table = heatmap.append('g').attr('class', 'table')
                    // depronto me toca borrar el Y de linkheight +link_margin, porque no lo tuve en cuenta antes
                    .attr('transform', 'translate(' + (Y_link_lenght + link_margin) + ',' + (0) + ')');
                    //.attr('transform', 'translate(' + (Y_link_lenght + link_margin) + ',' + (Y_link_lenght + link_margin) + ')');
            //##################################################################
            //##                   HELPER FUNCTIONS                           ##
            //##################################################################
            function collapse(d) {
                //console.log("d inside collapse");
                //console.log(d);
              if(d.children) {
                d._children = d.children;
                d._children.forEach(collapse);
                d.children = null;
              }
            }
            function expand(d) {
              if(d._children) {
                d.children = d._children;
                d._children.forEach(expand);
                d._children = null;
              }
            }
            let ptp = false;
            function get_path_to_parent(d) {
                if(ptp ===false){
                    output = "M" + (d.yLinkScaledLenght) + "," + (d.nodeY-1) +" L"+ (d.yLinkScaledLenght) + "," + d.nodeY;
                    //output = "M" + (Y_link_lenght) + "," + d.nodeY;
                    ptp = true;
                }
                if(d.parent) {
                  //create the path there
                    output = output + " L" + d.parent.yLinkScaledLenght + "," + d.nodeY
                                    + " L" + d.parent.yLinkScaledLenght + "," + d.parent.nodeY; 
                    output = output + get_path_to_parent(d.parent);
                }else{
                    ptp = false;
                }
              
              return(output);
            }
            // Toggle children collapse or expansion on click.
            function click(d) {
              if (d.children) {
                  d._children = d.children;
                  d.children = null;
                } else {
                  d.children = d._children;
                  d._children = null;
                }
                //console.log("on click d");
                //console.log(d);
              updateGraph(d);
            }
            function OnMouseOverExpand(d){
                d3.select(this).style("cursor", "zoom-in"); 
            }
            function OnMouseOverCollapse(d){
                d3.select(this).style("cursor", "zoom-out"); 
            }
            function OnMouseOverNoMore(d){
                d3.select(this).style("cursor", "not-allowed"); 
            }
            function expandAllParents(d){
                //console.log("d parents to expand");
                if(d._children){
                    //expand
                    d.children = d._children;
                    d._children = null;
                }else{
                    //console.log("something wrong happened this is the d");
                }
                if(d.parent){
                    /*console.log("d.expandAllParents()");
                    console.log(d.parent);*/
                    expandAllParents(d.parent);
                }else{
                    //console.log("no more parents, termine");
                }
            }
            let o;
            let tofind;
            function getFilteredData(d) {
                //if(d.data.name.toLowerCase().replace(/\s+/g, '').replace(/[^\w\s]/gi, '') === tofind.toLowerCase().replace(/\s+/g, '').replace(/[^\w\s]/gi, '')){
                if(d.idx === tofind){
                    //console.log("match");
                    o = d;
                    expandAllParents(o);
                }else{
                   // console.log("did not find it search children");
                    if(d._children){
                        d._children.forEach(getFilteredData);

                    }else{
                        //console.log("este nodo no tiene unexpanded children");
                    }
                    
                }
                return o;
            }
            
            
            function filter_partial_y(element, index, array) {
                return element === "YES";
            }
            function filter_partial_p(element, index, array) {
                return element === "PARTIAL";
            }
            function filter_partial_n(element, index, array) {
                return element === "NO";
            }
            function filter_partial_yp(element, index, array) {
                return (element === "YES" || element === "PARTIAL");
            }
            function filter_partial_yn(element, index, array) {
                return (element === "YES" || element === "NO");
            }
            function filter_partial_pn(element, index, array) {
                return (element === "PARTIAL" || element === "NO");
            }
            function filter_partial_ypn(element, index, array) {
                return (element === "PARTIAL" || element === "NO" || element === "YES");
            }
            let fc = filter_partial_ypn;
            function filteringLoop(element, index, array) {
                return element.result.every(fc);
            }
            
        //######################################################################
        //#                INITIALIZING THE BUTTONS ACTIONS                   ##
        //######################################################################
            sdbb.select(".ub")
                .on("click",function(){
                        //VALIDATE THE FIELDS
                        //Guarantee that at least a YES, PARTIAL, NO option is selected.
                        if(fcheck.some(d => d===true)){
                            //update the vector with the checkbox's values
                            fcheck = [d3.select(".fry").property("checked"),d3.select(".frp").property("checked"),d3.select(".frn").property("checked")];

                        }else{
                            alert("Please choose at least one value from YES, NO, PARTIAL");
                        }
                        initHeatmapData(m);
                    }
                )
            ;
            sdbb.select(".rb")
                .on("click",function(){
                        //The reset will depend on m 
                        //data_h.descendants().slice(1).forEach(collapse);
                        selected_data.descendants().slice(1).forEach(collapse);
                        updateGraph(selected_data);
                    }
                )
            ;
            sdbb.select(".eab")
                .on("click",function(){
                    //The expand all will depend on m 
                      selected_data.descendants().slice(1).forEach(expand);
                      //nodes.forEach(expand);
                      updateGraph(selected_data);
                    }
                )
            ;
            /*sdbb.select(".rpb")
                .on("click",function(){
                    console.log("mp_data.descendants()");
                    console.log(mp_data.descendants()[0].data.result);

                    console.log("the single sample of every");
                    console.log(mp_data.descendants()[0].data.result.every(filter_partial));
                    // have to extract those decendants that their nodes are different to no
                    console.log("the for each");
                    console.log(mp_data.descendants().filter(filteringLoop));
                    }
                )
            ;*/
            //######################################################################
            //##          INITIALIZING THE CHECKBOXES TO FILTER DATA              ##
            //######################################################################
                filter_menu_selec.on("change",function(){
                    console.log("on select event of the filter menu");
                    m = this.value;

                });
                d3.select(".fry").on("change",function(){
                    console.log("fry change");
                    console.log(d3.select(this).property("checked"));
                    fcheck[0] = d3.select(this).property("checked");
                });
                d3.select(".frp").on("change",function(){
                    console.log("frp change");
                    console.log(d3.select(this).property("checked"));
                    fcheck[1] = d3.select(this).property("checked");
                });
                d3.select(".frn").on("change",function(){
                    console.log("frn change");
                    console.log(d3.select(this).property("checked"));
                    fcheck[2] = d3.select(this).property("checked");
                });
        
        //######################################################################
        //##                     INIT HEATMAP DATA                            ##
        //######################################################################
            
        //######################################################################
        //##            FIRST LOAD THE FILE AND INITALIZE STUFF               ##
        //######################################################################
            d3.json("https://raw.githubusercontent.com/S0R0N/draft_viz/master/data/gp_assignments.json").then(
                    function(res){       
                    //Initializing root
                        samples  = res.sample_names;
                        rawJson  = res.property_tree;
                        let nodeSpaceX = heatmapWidth/samples.length;
                        let xNode = GxNodes.selectAll('g.x-node')
                        .data(samples);
                        xNode.join(
                            function(enter){
                                let xNodeEnter = enter
                                        .append("g")
                                        .attr('class',"x-node");
                                    xNodeEnter.append("text")
                                        .attr('class',"x-node")
                                        .style("text-anchor", 'start')
                                        .attr("font-family", "sans-serif")
                                        .attr("font-size", 12)
                                        .attr("transform", function(d,i) { return "translate(" + ((nodeSpaceX*i) + (nodeSpaceX/2))+ "," + sample_name_heigth + ")"+" rotate(270)"; })
                                        .text(function(d) { return d; })
                                    ;
                                return(xNodeEnter);
                            },
                            function(update){
                                let xNodeUpdate = update;
                                    xNodeUpdate.select("text.x-node")
                                        //.attr("transform", function(d,i) { return "translate(" + ((nodeSpaceX*i) + (nodeSpaceX/2))+ "," + 0 + ")"; });
                                        .attr("transform", function(d,i) { return "translate(" + ((nodeSpaceX*i) + (nodeSpaceX/2))+ "," + sample_name_heigth + ")"+" rotate(270)"; });
                                return(xNodeUpdate);
                            },
                            function(exit){
                                let xNodeExit = exit.remove();
                                    xNodeExit.select("text.x-node")
                                            .attr("font-size", 0);
                            }
                        );
                        //m ="path";
                        initHeatmapData(m);
                    }
                );
            
        function initHeatmapData (mode){
            //console.log("starting to run initHeatmapData");
            
            //******************************************************
            //**      SETTING THE YES NO PARTIAL FILTER           **
            //******************************************************
            let fm = Number(fcheck[0]).toString() + Number(fcheck[1]).toString() + Number(fcheck[2]).toString();
            switch(fm) {
                case "001":
                    //Get only NO
                    fc = filter_partial_n;
                break;
                case "010":
                    //Get only PARTIAL
                    fc = filter_partial_p;
                break;
                case "011":
                    //Get PARTIAL OR NO
                    fc = filter_partial_pn;
                break
                case "100":
                    //Get only YES
                    fc = filter_partial_y;
                break
                case "101":
                    //Get YES OR NO
                    fc = filter_partial_yn;
                break
                case "110":
                    //Get YES OR PARTIAL
                    fc = filter_partial_yp;
                break
                case "111":
                    ////Get YES OR PARTIAL OR NO (all)
                    fc = filter_partial_ypn;
                break
                default:
                  // code block
                  console.log("whaaaat?");
            }
            //******************************************************
            //**               INITIALIZING JSON                  **
            //******************************************************
            function initJson(d){
                if (d.property_id){
                    //console.log("d.data.property_id");
                    //console.log(d.data.property_id);
                    let o = mtpw.filter(function(x){
                        return x===d.property_id;
                    });
                    if(o.length>0){
                        d.type = "metapathway";
                    }else{
                        //check if the 
                        o = pw.filter(function(x){
                            return x===d.property_id;
                        });
                        if(o.length>0){
                            d.type = "pathway";
                        }else{
                            // try guild
                        }

                    }
                }else{
                    //es un step
                }
                if (d.children) d.children.forEach(function(d) { initJson(d); });
                return(d);
            }
            function filterType(d,t,v){//Aquii puedo agregar la condicion que quiero para los result. 
                if(d.type){
                    if (d.type===t){
                        // add it to the result vector
                        // check if the node follows the partial, no and yes filter. 
                        //console.log("d.result.every(fc)");
                        //console.log(d.result.every(fc));
                        if (d.result.every(fc)){
                            v.push(d);
                        }else{
                            //console.log("it was a selected thingy, but did not have the check filters");
                        }
                        //d.result.every
                        // if it follows add if not, then no. 
                        
                    }else{
                        // no add anything
                    }
                }else{
                    // no tiene type, no hay que revizarlo.
                }
                if (d.children) d.children.forEach(function(d) { filterType(d,t,v); });
            }                    
            function filterTypeW(d,t){
                let met_vector = [];
                filterType(d,t,met_vector);
                return(met_vector);
            }

            initJson(rawJson);
            let metp_vector = filterTypeW(rawJson,"metapathway");
            let p_vector = filterTypeW(rawJson,"pathway");
            //******************************************************
            //**     TRANSFORMING TO D3 HIERARCHY OBJECT JSON     **
            //******************************************************
            data_h  = d3.hierarchy(rawJson,function(d){return d.children;});
            mp_data = d3.hierarchy({"children":metp_vector,"enabled":false,"name":"meta-pathways","property_id":"GenProp_metapaths","result":rawJson.result},function(d){return d.children;});
            p_data  = d3.hierarchy({"children":p_vector,"enabled":false,"name":"pathways","property_id":"GenProp_paths","result":rawJson.result},function(d){return d.children;});

            //******************************************************
            //**    INITIALIZING CUSTOM VARS IN THE D3 OBJECTS    **
            //******************************************************
            function initCustomVars(d, y0, k) {
                counter++;
                let h = d.data.property_id?d.data.property_id:d.data.step_id;// the name, lowecase and with no spaces. 
                d.yLinkScaledLenght = (y0= (1+d.depth)) * k; //like an X distribution of the links in the Y axis network
                d.idx               = d.data.name.toLowerCase().replace(/\s+/g, '').replace(/[^\w\s]/gi, '')+h+counter ;
                if (d.children) d.children.forEach(function(d) { initCustomVars(d, y0, k); });
                return(d);
            }
            counter = 0;
            initCustomVars(data_h, data_h.depth, Y_link_lenght / data_h.height);

            counter = 0;
            initCustomVars(p_data, p_data.depth, Y_link_lenght / p_data.height);

            counter = 0;
            initCustomVars(mp_data, mp_data.depth, Y_link_lenght / mp_data.height);

            counter = 0;
            data_h.eachBefore(function(d){
                d.or = counter;//or stands for order
                counter++;
                return(d.or);
            });
            counter = 0;
            mp_data.eachBefore(function(d){
                d.or = counter;//or stands for order
                counter++;
                return(d.or);
            });
            counter = 0;
            p_data.eachBefore(function(d){
                d.or = counter;//or stands for order
                counter++;
                return(d.or);
            });
            counter = 0;
        //######################################################################
        //##                 FILTERING PATH, METAPATH AND ALL                 ##
        //######################################################################
            let phtext = "";
            switch(mode) {
                case "all":
                    //console.log("all");
                    selected_data = data_h;
                    selected_data.descendants().slice(1).forEach(expand);
                    phtext = "Search all functions here";
                break;
                case "path":
                    //console.log("path");
                    selected_data = p_data;
                    selected_data.descendants().slice(1).forEach(expand);
                    phtext = "Search for pathways here";
                break;
                case "mpath":
                    //console.log("mpath");
                    selected_data = mp_data;
                    selected_data.descendants().slice(1).forEach(expand);
                    phtext = "Search for metapathways here";
                break
                default:
                  // code block
                  console.log("whaaaat?");
            }
        //######################################################################
        //##                 INITIALIZING THE SELECT2 or SEARCH               ##
        //######################################################################
            $('.ndfs').select2({
                placeholder: phtext,
                width: 'resolve',
                //width: '818px',
                //data: data,
                minimumInputLength: 3
            }).on("select2:select", function(evt){
                    //Conecting the select to the hierarchical dataset
                    o="";
                    tofind = evt.params.data.id;
                    // searching the selected function on the hierchical dataset
                    // if the selected item is not expanded it will find it expand its parents and return it
                    selected_data.descendants().forEach(getFilteredData);
                    //after finding the selected item, refresh the heatmap
                    updateGraph(selected_data);
                    // animate the scroll to the item and the color of the selected item. 
                    let tar = d3.selectAll("."+o.idx)
                        .select(".y-node")
                        .style("fill", "blue")
                    ;
                    //Take into account the Zoom and the Y position of the scroll
                    d3.transition()
                        .duration(750)
                        .tween("scroll", scrollTween(o.nodeY*(gZoom.attr("scale"))))
                        .transition()
                            .duration(1500)
                            .tween("selected_text", borderTween("black"))
                    ;
                    function borderTween(target) {
                        return function() {

                        let ip = d3.interpolateRgb(tar.style("fill"),target);
                        return function(t) { 
                            //scrollTo(0, ip(t)); 
                            tar.style("fill",ip(t));
                            //change the object's color';
                        };
                      };
                    } 
                    function scrollTween(offset) {
                      return function() {
                        //let ip = d3.interpolateNumber(window.pageYOffset || document.scrollingElement.scrollTop, offset);
                        let ip = d3.interpolateNumber(d3.select(".mct").property("offsetTop"), offset);
                        return function(t) { d3.select(".mct").node().scrollTo(0, ip(t)); };
                        //return function(t) { scrollTo(0, ip(t)); };
                        //return function(t) { d3.select(".mct").property("offsetTop",ip(t)); 
                        //};
                      };
                    }    
                }
            );
        //######################################################################
        //##          INITIALIZING THE OPTIONS TO SHOW IN THE SEARCH2         ##
        //######################################################################        
            let opt_Enter = opt_names.selectAll(".ndfso_names_options")
                .data(selected_data.descendants(),function(d) {
                       return d.idx;
                   });

            opt_Enter.join(
                function (enter){
                    let optEnter = enter.append("option")
                        .attr("class","ndfso_names_options")
                        //.style("width","200px")
                        .attr("value",function(d){
                                //return "name-"+d.idx;
                                return d.idx;
                            }
                        )
                        .text(function(d){
                                return d.data.name;
                            }
                        );
                    return(optEnter);
                },
                function(update){
                    let optUpdate = update;
                    optUpdate.select("option.ndfso_names_options")
                        .attr("value",function(d){
                                    //return "name-"+d.idx;
                                    return d.idx;
                                }
                            )
                            .text(function(d){
                                return d.data.name;
                            }
                        );
                },
                function(exit){
                    let optExit = exit.remove();
                    return(optExit);
                }
            );
        
           //**************************************************************
            //**                    ZOOM                                  **
            //**************************************************************
            selected_data.descendants().slice(1).forEach(collapse);
            //let transform;
            let zoomv =  d3.zoom()
                .on("zoom", function () {
                    //getting the scrolled ratio before zooming
                    //console.log("zoom event");
                    
                    const scrollRatio = mct.property("scrollTop")/mct.property("scrollHeight");
                    d3.select(".zcc").property("value",  d3.event.scale);
                    //ZOOMING IN THE TARGET OBJECT
                    gZoom
                        .attr("transform", " translate("+0+ ","+0+")  scale(" + d3.event.transform.k+")")
                        .attr("scale",d3.event.transform.k)
                    ;
                    //SCALING THE SVG SO I EVEN IF I ZOOM I CAN STILL EXPLORE THE WHOLE OBJECT
                    svg
                        .attr("width", (b_width + margin.left + margin.right)*d3.event.transform.k)
                        .attr("height", (nodeSpaceY*(selected_data.descendants().length) + margin.top + margin.bottom +sample_name_heigth+20)*d3.event.transform.k)
                        .attr("viewBox", [0,0, (b_width + margin.left + margin.right)*d3.event.transform.k, (nodeSpaceY*(selected_data.descendants().length) + margin.top + margin.bottom +sample_name_heigth+20)*d3.event.transform.k])
                    ;
                    //SCALING THE Y POSITION OF THE SCROLL BAR TO KEEP THE SCREEN ORIGINAL COORDINATE. BEFORE ZOOMING. 
                    mct.node().scrollTo(0, scrollRatio*mct.property("scrollHeight"));
                    transform = d3.event.transform;
                })
                
                .scaleExtent([0.2, 1.05])
            ;

            svg.call(zoomv)
                .on("wheel.zoom", null)
                .on("touchstart.zoom", null)
                .on("touchmove.zoom", null)
                .on("touchend.zoom", null)
            ;
            svg.call(zoomv.transform,d3.zoomIdentity.translate(0,0).scale(0.5));
            
            svg
                .attr("width", (b_width + margin.left + margin.right))
                .attr("height", (nodeSpaceY*(selected_data.descendants().length) + margin.top + margin.bottom +sample_name_heigth+20)*0.5)
                .attr("viewBox", [0,0, (b_width + margin.left + margin.right)*0.5, (nodeSpaceY*(selected_data.descendants().length) + margin.top + margin.bottom +sample_name_heigth+20)*0.5])
            ;
            gZoom
                .attr("transform","scale(0.5)")
                .attr("scale",0.5)
            ;
            sdzc.on("input", function(d){
                zoomv.scaleTo(svg,zScale(d3.select(".zcc").property("value")));
            });
            
            updateGraph(selected_data);
        }
        //######################################################################
        //##                       UDAPTE FUNCTION                            ##
        //######################################################################
        function updateGraph (source){
                    nodes = selected_data.descendants();
                    nodes.sort(function(a, b){return a.or - b.or;});
                    
                    var nodeSpaceY = 20;
                    counter = 0;
                    nodes.forEach(function(d){
                        d.id = counter;
                        d.nodeY = ((nodeSpaceY)*(d.id+1)) - (nodeSpaceY/2);
                        counter++;
                        return(d.id);
                    });

                    svg
                        .attr("width", b_width + margin.left + margin.right )
                        .attr("height", nodeSpaceY*nodes.length + margin.top + margin.bottom +sample_name_heigth+20)
                        .attr("viewBox", [0, 0, b_width + margin.left + margin.right, nodeSpaceY*nodes.length + margin.top + margin.bottom +sample_name_heigth+20])
                        //.attr('transform', 'translate('+ (0) + ',' + (0) + ')')
                    ;
                    
                    var yLink = GyLinks.selectAll('g.link') 
                            .data(nodes,function(d,i) {
                                return d.idx;
                            });
                    //##################################################################
                    //##                     DRAWING THE NETWORK                      ##
                    //##################################################################
                        yLink.join(
                            function(enter){
                                var yLinkEnter = enter
                                        .append("g")
                                        .attr('class',function(d) {
                                            return 'link '+ d.idx;}
                                        );
                                yLinkEnter
                                        .append("path")
                                        .attr('class',function(d) {return 'link '+ d.idx;})
                                        .style('fill', 'none')
                                        .style('stroke', '#000')
                                        .style('stroke-width', 1)
                                        .attr("d",function(d){
                                                return get_path_to_parent(d);
                                            });
                                    yLinkEnter.append("circle")
                                        .attr('class',function(d) {return 'link '+ d.idx;})
                                        .attr('r', 2)
                                        .attr("transform", function(d) {
                                          return "translate(" + d.yLinkScaledLenght + "," + d.nodeY + ")";
                                        });
                                    return(yLinkEnter);
                            },
                            function(update){
                                var yLinkUpdate = update;
                                    yLinkUpdate.select("path.link")
                                        .attr("d",function(d){
                                            return get_path_to_parent(d);
                                        });
                                        
                                    yLinkUpdate.select("circle")
                                        .attr("transform", function(d){
                                              return "translate(" + d.yLinkScaledLenght + "," + d.nodeY + ")";
                                            }
                                        );
                                return(yLinkUpdate);
                            },
                            function(exit){
                                var yLinkExit = exit.remove();
                                    yLinkExit.select("g.link");
                                    yLinkExit.select("circle.link")
                                            .attr("r",1e-6);
                                    yLinkExit.select("path.link")
                                            .style('stroke-width', 0);                                    
                                return(yLinkExit);
                            }
                        );
                   // Ynode has the same proble that ylink had, the g element is not being created and the sub elements are flying. Gotta ground them. 
                    //##################################################################
                    //##                     DRAWING THE NETWORK                      ##
                    //##################################################################
                        
                    var yNode = GyNodes.selectAll('g.y-node')
                            .data(nodes,function(d) {
                                return d.idx;
                            });
                        yNode.join(
                            function(enter){
                                let yNodeEnter = enter
                                        .append("g")
                                        .attr('class',function(d) {
                                            return 'y-node '+ d.idx;}
                                        );
                                    yNodeEnter.append("text")
                                        .attr('class',function(d) {
                                            return 'y-node '+ d.idx;}
                                        )
                                        //.attr('transform', function(d) { return 'translate(' + 0 + ',' + (d.nodeY +(nodeSpaceY/2)) + ')'; })
                                        //.attr('transform', function(d) { return 'translate(' + 0 + ',' + (d.nodeY+3) + ')'; })
                                        .attr('transform', function(d) { 
                                            //console.log("d.yLinkScaledLenght");
                                            //console.log(d.yLinkScaledLenght);
                                            return 'translate(' + d.yLinkScaledLenght + ',' + (d.nodeY+3) + ')'; 
                                        })
                                        .attr("font-family", "sans-serif")
                                        .attr("font-size", 12)
                                        .text(function(d) {
                                            let t = "normal";
                                            if(d.height ===0){
                                                //es extremo font-weight is normal
                                                t = d.data.name;
                                            }else{
                                                t = d._children?d.data.name+"  +":d.data.name+"  -";
                                                //t = d.children.filter(d => d.show ===false).length>0?d.data.name+"  +":d.data.name+"  -";
                                            }    
                                                return t;
                                            }
                                        )
                                        //.attr('cursor', 'pointer')
                                        .style("fill","black")
                                        .style("font-weight", function(d) {
                                            let fw = "normal";
                                            if(d.height ===0){
                                                //es extremo font-weight is normal
                                                fw = "normal";
                                            }else{
                                                fw = d.children ? "normal": "bold";
                                                //fw = d.children.filter(d => d.show ===false).length>0?"bold":"normal";
                                            }
                                            return (fw);
                                        })
                                        .style("font-style", function(d) {
                                            return (d.children ? "italic": "normal");
                                        })
                                        //cursor type
                                        .on('mouseover', function (d){//Changing the cursor appearance 
                                            if(d.children){
                                                d3.select(this).style("cursor", "zoom-out");
                                            }else{
                                                d3.select(this).style("cursor", "zoom-in");
                                            }
                                            if(d.height === 0){
                                                d3.select(this)
                                                    .style("cursor", "not-allowed");
                                                }
                                            }
                                        )
                                        .on('click', click);
                                return(yNodeEnter);
                            },
                            function(update){
                                let yNodeUpdate = update;
                                    yNodeUpdate.select("text")
                                        .style("fill","black")
                                        .style("font-weight", function(d) {
                                            let fw = "normal";
                                            if(d.height ===0){
                                                //es extremo font-weight is normal
                                                fw = "normal";
                                            }else{
                                                fw = d.children ? "normal": "bold";
                                                //fw = d.children.filter(d => d.show ===false).length>0?"bold":"normal";
                                            }
                                            return (fw);
                                        })
                                        .style("font-style", function(d) {
                                            
                                            return (d.children ? "italic": "normal");
                                        })
                                        .text(function(d) {
                                            let t = "normal";
                                            if(d.height ===0){
                                                //es extremo font-weight is normal
                                                t = d.data.name;
                                            }else{
                                                //t = d.children.filter(d => d.show ===false).length>0?d.data.name+"  +":d.data.name+"  -";
                                                t = d._children?d.data.name+"  +":d.data.name+"  -";
                                            }    
                                                return t;
                                            }
                                        )
                                        .on('mouseover', function (d){//Changing the cursor appearance 
                                            if(d.children){
                                                d3.select(this).style("cursor", "zoom-out");
                                            }else{
                                                d3.select(this).style("cursor", "zoom-in");
                                            }
                                            if(d.height === 0){
                                                d3.select(this)
                                                    .style("cursor", "not-allowed");
                                                }
                                            }
                                        )
                                        //cursor type
                                        //
                                        //.attr('transform', function(d) { return 'translate(' + 0 + ',' + (d.nodeY +(nodeSpaceY/2)) + ')'; });
                                        //.attr('transform', function(d) { return 'translate(' + 0 + ',' + (d.nodeY+3) + ')'; });
                                        .attr('transform', function(d) { return 'translate(' + d.yLinkScaledLenght + ',' + (d.nodeY+3) + ')'; });
                                return(yNodeUpdate);
                            },
                            function(exit){
                                let yNodeExit = exit.remove();
                                    yNodeExit.select("text.link")
                                            .attr("font-size", 0);
                            }
                        );
                    //##################################################################
                    //##                 END DRAWING THE NETWORK                      ##
                    //##################################################################

                    //##################################################################
                    //##                     DRAWING THE BOXES                        ##
                    //##################################################################
                    // Number of columns are the numeber of samples
                    
                    var nCols = samples.length;
                    var bandX = d3.scaleBand()
                            .domain(d3.range(nCols))
                            .range([0, heatmapWidth]);

                    var rows = table.selectAll('.row')
                           .data(nodes,function(d) {
                               return d.idx;
                           });
                    rows.join(
                        function(enter){
                            let rowEnter = enter.append('g')
                                //.attr('class', 'row')
                                .attr('class',function(d) {return 'row '+ d.idx;})
                                .attr('transform', function(d, i) {

                                    return 'translate(0, ' + (d.nodeY- (nodeSpaceY/2)) + ')';
                                });  
                            let rowEnterRect = rowEnter
                                    .selectAll('rect')
                                    .data(function(d) {
                                        return(d.data.result);
                                    });
                            rowEnterRect
                                    .join(
                                        function(enter){
                                            let rowEnterRect = enter.append('rect')
                                                .style('fill', function (d) {return heatColor(d);})
                                                .style('opacity', 0.7)
                                                .attr('x', function(d, i) {return bandX(i);})
                                                .style('stroke', '#000')
                                                .style('stroke-width', 1)
                                                .attr('width', bandX.bandwidth())
                                                .attr('height', nodeSpaceY);
                                                //.attr('height', bandX.bandwidth());
                                            return(rowEnterRect);
                                        }
                                    );
                        },
                        function(update){
                            //no le tengo mucha fe por la division del joing update del objeto children
                            //probably I have to create a group to modify these dudes 
                            //console.log("updating row");
                            let rowUpdate = update;
                                rowUpdate
                                    .attr('transform', function(d, i) {
                                        return 'translate(0, ' + (d.nodeY- (nodeSpaceY/2)) + ')';
                                    });
                                rowUpdate.selectAll('rect')
                                    .style('fill', function (d) {
                                            //console.log("rect data on update");
                                            return heatColor(d);
                                        })
                                    .style('opacity', 0.7)
                                    .attr('x', function(d, i) {return bandX(i);})
                                    .style('stroke', '#000')
                                    .style('stroke-width', 1)
                                    .attr('width', bandX.bandwidth())
                                    .attr('height', nodeSpaceY);
                                    //.attr('height', bandX.bandwidth());
                                    //.attr('height', bandY.bandwidth());
                        },
                        function(exit){
                            let rowExit = exit.remove();
                                rowExit.selectAll("rect")
                                    .style('stroke', '#fff')
                                    .style('stroke-width', 1e-6)
                                    .attr('width', 1e-6)
                                    .attr('height', 1e-6);
                            return(rowExit);
                        }
                    );
                };            
        </script>
    </body>
</html>
